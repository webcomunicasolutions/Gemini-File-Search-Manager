<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini File Search Manager</title>
    <!-- CRITICAL: Include marked.js for markdown support -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ==========================================
           MODERN GEMINI FILE SEARCH MANAGER UI
           ========================================== */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Roboto', 'Segoe UI', sans-serif;
            background: linear-gradient(to bottom, #F9FAFB 0%, #F3F4F6 100%);
            min-height: 100vh;
            padding: 32px 20px;
            color: #111827;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* === HEADER === */
        header {
            text-align: center;
            margin-bottom: 24px;
            padding: 48px 32px;
            background: #FFFFFF;
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05),
                        0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(229, 231, 235, 0.8);
        }

        header h1 {
            font-size: 2.75em;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #005a8a 0%, #0081BA 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            letter-spacing: -1px;
        }

        header h1 a:hover {
            color: #0081BA !important;
            text-decoration: underline;
        }

        header p {
            font-size: 1.15em;
            color: #6B7280;
            font-weight: 400;
        }

        /* === TAB NAVIGATION === */
        .tab-navigation {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 8px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(229, 231, 235, 0.8);
            display: flex;
            gap: 8px;
        }

        .tab-btn {
            flex: 1;
            padding: 16px 24px;
            border: none;
            background: transparent;
            color: #6B7280;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: #F3F4F6;
            color: #374151;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #0081BA 0%, #005a8a 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(0, 129, 186, 0.2);
        }

        /* === TAB CONTENT === */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* === MAIN GRID LAYOUT === */
        .main-content {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 24px;
            margin-bottom: 20px;
            align-items: start;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* === CARD COMPONENTS === */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(229, 231, 235, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card h2 {
            color: #0081BA;
            margin-bottom: 20px;
            font-size: 1.15em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* === FILE UPLOAD === */
        .drop-zone {
            border: 2px dashed #CBD5E1;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #F8FAFC;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: #0081BA;
            background: #e6f7ff;
        }

        .file-input {
            display: none;
        }

        /* === FILE LIST === */
        .file-item {
            padding: 14px;
            background: #F8FAFC;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #0081BA;
            transition: all 0.3s ease;
        }

        .file-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .file-item-name {
            font-weight: 600;
            color: #0F172A;
            font-size: 0.9em;
            word-break: break-all;
            overflow-wrap: break-word;
            max-width: 85%;
            line-height: 1.4;
        }

        .btn-delete-file {
            padding: 8px 12px;
            background: #EF4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            min-width: 40px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .btn-delete-file:hover {
            background: #DC2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        /* === CHAT INTERFACE === */
        .chat-messages {
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            background: #F8FAFC;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .message {
            margin-bottom: 20px;
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            max-width: 80%;
            padding: 14px 18px;
            border-radius: 12px;
            word-wrap: break-word;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #0081BA 0%, #005a8a 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.assistant .message-content {
            background: #FFFFFF;
            color: #111827;
            border: 1px solid rgba(229, 231, 235, 0.9);
            border-bottom-left-radius: 6px;
        }

        /* === MARKDOWN FORMATTING IN MESSAGES === */
        .message-content p {
            margin: 0 0 12px 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul, .message-content ol {
            margin: 8px 0 12px 20px;
            padding-left: 0;
        }

        .message-content li {
            margin: 4px 0;
        }

        .message-content strong {
            font-weight: 700;
            color: #0081BA;
        }

        .message-content code {
            background: #F3F4F6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background: #1F2937;
            color: #F3F4F6;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
        }

        .message-content h1, .message-content h2, .message-content h3 {
            margin: 16px 0 8px 0;
            color: #0081BA;
        }

        .message-content blockquote {
            border-left: 4px solid #0081BA;
            padding-left: 12px;
            margin: 12px 0;
            color: #6B7280;
            font-style: italic;
        }

        /* === LOADING INDICATOR === */
        .message.loading .message-content {
            background: #F3F4F6;
            border: 1px solid #E5E7EB;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 0;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            background: #0081BA;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* === BUTTONS === */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0081BA 0%, #005a8a 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 129, 186, 0.3);
        }

        .btn-secondary {
            background: #F3F4F6;
            color: #374151;
            border: 1px solid #D1D5DB;
        }

        .btn-secondary:hover {
            background: #E5E7EB;
            transform: translateY(-1px);
        }

        /* === MODAL STYLES === */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            margin: 0;
            color: #0081BA;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6B7280;
            padding: 8px;
            line-height: 1;
        }

        .modal-close:hover {
            color: #EF4444;
        }

        .store-card {
            background: #F9FAFB;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #0081BA;
            transition: all 0.3s ease;
        }

        .store-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .store-card.active {
            border-left-color: #10B981;
            background: #ECFDF5;
        }

        .store-card h3 {
            margin: 0 0 12px 0;
            color: #0F172A;
            font-size: 1.1em;
        }

        .store-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
            font-size: 0.9em;
        }

        .store-info-item {
            display: flex;
            gap: 8px;
        }

        .store-info-item strong {
            color: #6B7280;
        }

        .store-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        /* === DOCUMENT MANAGEMENT STYLES === */
        .edit-doc-btn:hover {
            background: #93C5FD !important;
            border-color: #60A5FA !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(30, 64, 175, 0.2);
        }

        .delete-doc-btn:hover {
            background: #FCA5A5 !important;
            border-color: #F87171 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
        }

        .toggle-docs-btn:hover {
            background: #E5E7EB !important;
            border-color: #9CA3AF !important;
        }

        .document-item {
            transition: all 0.2s ease;
        }

        .document-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        /* === API DOCUMENTATION STYLES === */
        .api-docs-container {
            display: grid;
            gap: 24px;
        }

        .api-section {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(229, 231, 235, 0.8);
        }

        .api-section h2 {
            color: #0081BA;
            margin-bottom: 16px;
            font-size: 1.5em;
            font-weight: 700;
        }

        .api-info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin: 24px 0;
        }

        .api-info-card {
            background: #F9FAFB;
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid #0081BA;
            min-width: 0;
        }

        .api-info-card strong {
            display: block;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .api-info-card .value {
            color: #0081BA;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
            word-break: break-all;
            overflow-wrap: break-word;
            line-height: 1.4;
        }

        .code-block-container {
            position: relative;
            margin: 16px 0 24px 0;
        }

        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1F2937;
            padding: 12px 16px;
            border-radius: 12px 12px 0 0;
        }

        .code-language {
            color: #9CA3AF;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .copy-btn {
            background: #374151;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: #0081BA;
        }

        .copy-btn.copied {
            background: #10B981;
        }

        .code-block {
            background: #1F2937;
            color: #F3F4F6;
            padding: 20px;
            border-radius: 0 0 12px 12px;
            overflow-x: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }

        .code-block pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .warning-banner {
            background: #FEF3C7;
            border-left: 4px solid #F59E0B;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }

        .warning-banner strong {
            color: #92400E;
            display: block;
            margin-bottom: 8px;
        }

        .warning-banner p {
            color: #78350F;
            margin: 0;
            font-size: 0.95em;
        }

        /* Custom scrollbar for files list */
        #filesList::-webkit-scrollbar {
            width: 8px;
        }

        #filesList::-webkit-scrollbar-track {
            background: #F3F4F6;
            border-radius: 4px;
        }

        #filesList::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 4px;
        }

        #filesList::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        /* Smooth transition for toggle */
        #filesList {
            transition: max-height 0.3s ease;
        }

        /* === CHAT INPUT STYLING === */
        .chat-input-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-input-container input[type="text"] {
            flex: 1;
            padding: 16px 20px;
            font-size: 16px;
            border: 2px solid #D1D5DB;
            border-radius: 12px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .chat-input-container input[type="text"]:focus {
            outline: none;
            border-color: #0081BA;
            box-shadow: 0 0 0 3px rgba(0, 129, 186, 0.1);
        }

        .chat-input-container input[type="text"]:disabled {
            background: #F3F4F6;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* === FOOTER MINIMALISTA === */
        footer {
            margin-top: 64px;
            padding: 48px 0;
            border-top: 1px solid #E5E7EB;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 48px;
            margin-bottom: 32px;
        }

        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column;
                gap: 32px;
            }
        }

        .footer-logos {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        @media (max-width: 768px) {
            .footer-logos {
                flex-direction: column;
                gap: 24px;
            }
        }

        .logo-link {
            display: inline-block;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .logo-link:hover {
            opacity: 1;
        }

        .logo-link img {
            max-width: 180px;
            height: auto;
        }

        @media (max-width: 768px) {
            .logo-link img {
                max-width: 160px;
            }
        }

        .footer-social {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .social-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: transparent;
            border-radius: 50%;
            text-decoration: none;
            color: #6B7280;
            transition: all 0.3s ease;
        }

        .social-link:hover {
            color: #0081BA;
            background: #F3F4F6;
        }

        .social-link svg {
            width: 20px;
            height: 20px;
        }

        .footer-bottom {
            text-align: center;
            color: #9CA3AF;
            font-size: 13px;
        }

        .footer-bottom p {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="display: flex; align-items: center; gap: 20px;">
                        Gemini File Search Manager
                        <a href="https://webcomunica.solutions/" target="_blank" rel="noopener noreferrer" style="display: flex; align-items: center; gap: 10px; text-decoration: none; transition: opacity 0.3s; margin-top: 8px;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                            <span style="font-size: 26px; font-weight: 400; color: #6B7280;">by</span>
                            <img src="/static/images/webcomunica.png" alt="Webcomunica Solutions" style="height: 48px; width: auto;">
                        </a>
                    </h1>
                    <p data-i18n="header.subtitle">Upload documents and chat with your files using AI-powered search</p>

                    <!-- Inspiration Credit -->
                    <div style="margin-top: 12px;">
                        <a href="https://youtu.be/_wN2v8o-imo" target="_blank" rel="noopener noreferrer"
                           style="display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px;
                                  background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
                                  border: 1px solid #F59E0B; border-radius: 6px;
                                  text-decoration: none; font-size: 13px; font-weight: 500;
                                  color: #92400E; transition: all 0.2s; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.1);"
                           onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(245, 158, 11, 0.2)'"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(245, 158, 11, 0.1)'">
                            <span style="font-size: 16px;">üí°</span>
                            <span data-i18n="header.inspiration">Inspired by Mark Kashef's tutorial</span>
                            <span style="font-size: 14px;">‚ñ∂Ô∏è</span>
                        </a>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button onclick="changeLanguage('es')" id="lang-es" class="lang-btn" style="padding: 8px 16px; border: 2px solid #0081BA; background: #0081BA; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">
                        üá™üá∏ ES
                    </button>
                    <button onclick="changeLanguage('en')" id="lang-en" class="lang-btn" style="padding: 8px 16px; border: 2px solid #D1D5DB; background: white; color: #6B7280; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;">
                        üá∫üá∏ EN
                    </button>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('upload')" data-i18n="tabs.upload">
                üì§ Upload
            </button>
            <button class="tab-btn" onclick="switchTab('chat')" data-i18n="tabs.chat">
                üí¨ Chat
            </button>
            <button class="tab-btn" onclick="switchTab('stores')" data-i18n="tabs.stores">
                üì¶ File Stores
            </button>
            <button class="tab-btn" onclick="switchTab('settings')" data-i18n="tabs.settings">
                ‚öôÔ∏è Settings
            </button>
            <button class="tab-btn" onclick="switchTab('docs')" data-i18n="tabs.docs">
                üìö Docs & Help
            </button>
        </div>

        <!-- Upload Tab Content -->
        <div id="upload-tab" class="tab-content active">
            <div style="max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 350px 1fr; gap: 20px;">

                <!-- Left Column: Store Management -->
                <div class="card" style="height: fit-content;">
                    <h2 style="font-size: 18px;" data-i18n="upload.stores.title">üì¶ Stores</h2>
                    <p style="color: #6B7280; margin-bottom: 16px; font-size: 13px;" data-i18n="upload.stores.subtitle">
                        Gestiona tus File Search Stores
                    </p>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 12px; font-weight: 500; color: #374151;" data-i18n="upload.stores.newName">
                            Nombre del nuevo store:
                        </label>
                        <input type="text" id="newStoreName" data-i18n-placeholder="upload.stores.placeholder" placeholder="Ej: Docs 2024"
                            style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 13px; margin-bottom: 8px;">
                        <button id="createStoreBtn" class="btn btn-primary" style="width: 100%; padding: 8px; font-size: 13px;" data-i18n="upload.stores.create">
                            ‚ûï Crear Store
                        </button>
                    </div>

                    <!-- Stores List Toggle -->
                    <button id="toggleStoresListBtn" class="btn-secondary" style="width: 100%; padding: 8px; font-size: 13px; margin-bottom: 12px;" data-i18n="upload.stores.view">
                        üìã Ver Stores Disponibles
                    </button>

                    <!-- Current Stores List (Hidden by default) -->
                    <div id="currentStoresList" style="display: none;">
                        <div id="storesListContainer"></div>
                    </div>
                </div>

                <!-- Right Column: Upload Documents -->
                <div class="card">
                    <h2 data-i18n="upload.docs.title">üì§ Upload Documents</h2>
                    <p style="color: #6B7280; margin-bottom: 20px; font-size: 14px;" data-i18n="upload.docs.subtitle">
                        Selecciona archivos y elige a qu√© store subirlos
                    </p>

                    <!-- Upload Section -->
                    <div class="sidebar">
                    <!-- Upload Section -->
                    <div class="card">
                        <h2 data-i18n="upload.docs.title">üì§ Upload Documents</h2>
                        <div class="drop-zone" id="dropZone">
                            <div>üìÅ</div>
                            <p data-i18n="upload.docs.dropZone"><strong>Drag & drop</strong> your files here</p>
                            <p style="font-size: 0.8em;" data-i18n="upload.docs.dropZoneSub">or click to browse (m√∫ltiples archivos)</p>
                        </div>
                        <input type="file" id="fileInput" class="file-input" multiple>

                        <!-- Files Queue Section -->
                        <div id="filesQueue" style="display: none; margin-top: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 style="margin: 0; font-size: 16px; color: #111827;"><span data-i18n="upload.queue.title">üìã Archivos en cola</span> (<span id="queueCount">0</span>)</h3>
                                <button id="clearQueue" class="btn-secondary" style="padding: 6px 12px; font-size: 12px;" data-i18n="upload.queue.clear">
                                    üóëÔ∏è Limpiar cola
                                </button>
                            </div>
                            <div id="filesQueueList" style="max-height: 300px; overflow-y: auto;"></div>
                            <button id="uploadAllFiles" class="btn btn-primary" style="width: 100%; margin-top: 16px;" data-i18n="upload.docs.uploadAll">
                                üì§ Subir Todos los Archivos
                            </button>
                        </div>

                        <!-- Metadata Section -->
                        <div id="metadataSection" style="display: none; margin-top: 20px; padding: 16px; background: #F9FAFB; border-radius: 12px; border: 1px solid #E5E7EB;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #111827;">
                                <span data-i18n="upload.metadata.title">üè∑Ô∏è Agregar Metadatos (Opcional)</span>
                                <button id="toggleMetadata" class="btn-secondary" style="float: right; padding: 4px 12px; font-size: 12px;" data-i18n="upload.metadata.addField">
                                    ‚ûï Agregar campo
                                </button>
                            </h3>
                            <p style="margin: 0 0 12px 0; font-size: 13px; color: #6B7280;" data-i18n="upload.metadata.description">
                                Los metadatos te ayudan a identificar y filtrar tus documentos. M√°ximo 20 campos.
                            </p>

                            <!-- Templates Selector -->
                            <div style="margin-bottom: 16px; padding: 12px; background: #EFF6FF; border-radius: 8px; border: 1px solid #BFDBFE; overflow: hidden;">
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #1E40AF;" data-i18n="upload.metadata.templateLabel">
                                    üìã Usar plantilla predefinida:
                                </label>
                                <select id="metadataTemplate" style="width: 100%; max-width: 100%; padding: 8px; border: 1px solid #93C5FD; border-radius: 6px; font-size: 14px; background: white; box-sizing: border-box;">
                                    <option value="" data-i18n="upload.metadata.templateSelect">-- Selecciona un tipo de documento --</option>
                                    <option value="factura" data-i18n="upload.metadata.templateInvoice">üìÑ Factura</option>
                                    <option value="contrato" data-i18n="upload.metadata.templateContract">üìù Contrato</option>
                                    <option value="informe" data-i18n="upload.metadata.templateReport">üìä Informe</option>
                                    <option value="manual" data-i18n="upload.metadata.templateManual">üìñ Manual/Gu√≠a</option>
                                    <option value="presentacion" data-i18n="upload.metadata.templatePresentation">üìΩÔ∏è Presentaci√≥n</option>
                                    <option value="acta" data-i18n="upload.metadata.templateMinutes">üìã Acta/Minuta</option>
                                    <option value="certificado" data-i18n="upload.metadata.templateCertificate">üéì Certificado</option>
                                    <option value="email" data-i18n="upload.metadata.templateEmail">‚úâÔ∏è Email/Comunicaci√≥n</option>
                                </select>
                            </div>

                            <!-- AI Suggestions Button -->
                            <div style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%); border-radius: 8px; border: 1px solid #86EFAC;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                    <label style="font-size: 13px; font-weight: 500; color: #166534;" data-i18n="upload.metadata.aiTitle">
                                        ü§ñ Sugerencias Inteligentes con IA
                                    </label>
                                </div>
                                <p style="margin: 0 0 12px 0; font-size: 12px; color: #15803D;" data-i18n="upload.metadata.aiDescription">
                                    Gemini analizar√° tu documento y sugerir√° metadatos autom√°ticamente
                                </p>
                                <button id="suggestMetadataBtn" class="btn-secondary" style="width: 100%; padding: 10px; background: #22C55E; color: white; border: none; font-weight: 600;" data-i18n="upload.metadata.aiButton" disabled>
                                    ‚ú® Analizar Documento y Sugerir Metadatos
                                </button>
                                <div id="aiSuggestionStatus" style="margin-top: 8px; font-size: 12px; display: none;"></div>
                            </div>

                            <div id="metadataFields"></div>

                            <!-- Chunking Configuration -->
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #E5E7EB;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 12px;">
                                    <input type="checkbox" id="enableChunking" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 500; color: #111827;" data-i18n="upload.metadata.chunkingTitle">üî™ Configuraci√≥n Avanzada de Chunking</span>
                                </label>
                                <div id="chunkingConfig" style="display: none; margin-top: 12px;">
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; margin-bottom: 4px; font-size: 13px; color: #374151;" data-i18n="upload.metadata.chunkingMaxTokens">
                                            Tokens m√°ximos por chunk:
                                        </label>
                                        <input type="number" id="maxTokensPerChunk" value="200" min="50" max="1000"
                                            style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 13px; color: #374151;" data-i18n="upload.metadata.chunkingOverlap">
                                            Tokens de solapamiento:
                                        </label>
                                        <input type="number" id="maxOverlapTokens" value="20" min="0" max="200"
                                            style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                </div>
                            </div>

                            <button id="uploadWithMetadata" class="btn btn-primary" style="width: 100%; margin-top: 16px; display: none;">
                                üì§ Subir Documento
                            </button>
                        </div>

                        <div id="uploadStatus"></div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Chat Tab Content -->
        <div id="chat-tab" class="tab-content">
            <div style="max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 280px 1fr; gap: 20px;">

                <!-- Left Column: Store Selector -->
                <div class="card" style="height: fit-content;">
                    <h3 style="font-size: 16px; margin-bottom: 12px; color: #111827;" data-i18n="chat.storeActive">üì¶ Store Activo</h3>
                    <p style="color: #6B7280; margin-bottom: 12px; font-size: 12px;" data-i18n="chat.selectStore">
                        Selecciona el store para chatear
                    </p>
                    <select id="chatStoreSelector" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 13px; margin-bottom: 12px;">
                        <option value="" data-i18n="chat.selectStoreOption">-- Selecciona un store --</option>
                    </select>
                    <div id="chatStoreInfo" style="display: none; padding: 10px; background: #EFF6FF; border-radius: 6px; border: 1px solid #BFDBFE; font-size: 12px;">
                        <div style="color: #1E40AF; font-weight: 600; margin-bottom: 4px;" id="chatStoreInfoName"></div>
                        <div style="color: #6B7280;" id="chatStoreInfoDocs"></div>
                    </div>
                </div>

                <!-- Right Column: Chat Section -->
                <div class="card chat-section">
                    <h2 data-i18n="chat.title">üí¨ Chat with Your Documents</h2>
                    <div class="chat-messages" id="chatMessages">
                        <div class="empty-state" data-i18n="chat.emptyState">Selecciona un store para comenzar</div>
                    </div>

                    <!-- Metadata Filters Section -->
                    <div id="metadataFiltersSection" style="padding: 12px; background: #F9FAFB; border-radius: 8px; margin-bottom: 12px; border: 1px solid #E5E7EB; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label style="font-size: 13px; font-weight: 600; color: #374151;" data-i18n="chat.filters.title">
                                üîç Filtrar por metadatos:
                            </label>
                            <button id="toggleFiltersBtn" class="btn-secondary" style="padding: 4px 12px; font-size: 12px;" data-i18n="chat.filters.add">
                                ‚ûï Agregar filtro
                            </button>
                        </div>
                        <div id="activeFilters" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 24px;"></div>
                    </div>

                    <div class="chat-input-container">
                        <button id="showFiltersBtn" class="btn-secondary" style="padding: 10px; margin-right: 8px;" data-i18n-title="chat.filters.tooltip" title="Filtrar por metadatos">
                            üîç
                        </button>
                        <input type="text" id="chatInput" data-i18n-placeholder="chat.placeholder" placeholder="Ask a question..." disabled>
                        <button class="btn btn-primary" id="sendBtn" disabled data-i18n="chat.send">Send</button>
                    </div>
                </div>

            </div>
        </div>

        <!-- File Stores Tab -->
        <div id="stores-tab" class="tab-content">
            <div class="card">
                <h2 data-i18n="stores.title">üì¶ Todos los File Stores</h2>
                <div id="storesTabList"></div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div style="max-width: 900px; margin: 0 auto;">
                <div class="card">
                    <h2 data-i18n="settings.title">‚öôÔ∏è Settings</h2>
                    <p style="color: #6B7280; margin-bottom: 24px;" data-i18n="settings.subtitle">Configura tu aplicaci√≥n RAG</p>

                    <!-- API Key Section -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="font-size: 18px; margin-bottom: 16px; color: #111827;" data-i18n="settings.apiKey.title">üîë API Key de Gemini</h3>

                        <div class="warning-banner" style="margin-bottom: 16px;">
                            <strong data-i18n="settings.apiKey.warningTitle">‚ö†Ô∏è Aviso de Seguridad</strong>
                            <p data-i18n="settings.apiKey.warningText">Nunca compartas tu API key p√∫blicamente. No la subas a GitHub ni la expongas en c√≥digo del lado del cliente.</p>
                        </div>

                        <div style="background: #F9FAFB; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #374151;" data-i18n="settings.apiKey.current">
                                API Key Actual:
                            </label>
                            <div id="currentApiKey" style="font-family: Monaco, monospace; background: white; padding: 12px; border-radius: 6px; border: 1px solid #D1D5DB; color: #0081BA; font-size: 13px; word-break: break-all;">
                                Cargando...
                            </div>
                        </div>

                        <div style="background: #F9FAFB; padding: 16px; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #374151;" data-i18n="settings.apiKey.update">
                                Actualizar API Key:
                            </label>
                            <div style="display: flex; gap: 12px;">
                                <input type="password" id="newApiKeyInput" data-i18n-placeholder="settings.apiKey.inputPlaceholder" placeholder="Ingresa nueva API key..."
                                    style="flex: 1; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-family: Monaco, monospace; font-size: 13px;">
                                <button onclick="updateApiKey()" class="btn btn-primary" style="white-space: nowrap;" data-i18n="settings.apiKey.updateBtn">
                                    Actualizar Key
                                </button>
                            </div>
                            <p style="margin: 8px 0 0 0; font-size: 12px; color: #6B7280;" data-i18n="settings.apiKey.getKey">
                                üí° Obt√©n tu API key en <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #0081BA;">Google AI Studio</a>
                            </p>
                        </div>
                    </div>

                    <!-- Model Configuration -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="font-size: 18px; margin-bottom: 16px; color: #111827;" data-i18n="settings.model.title">ü§ñ Configuraci√≥n del Modelo</h3>

                        <div style="background: #F9FAFB; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #374151;" data-i18n="settings.model.chatModel">
                                    Modelo para Chat:
                                </label>
                                <div style="font-family: Monaco, monospace; color: #0081BA; font-size: 14px; font-weight: 600;">
                                    gemini-2.5-flash
                                </div>
                                <p style="margin: 4px 0 0 0; font-size: 12px; color: #6B7280;" data-i18n="settings.model.chatModelDesc">
                                    Modelo optimizado para RAG con File Search
                                </p>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #374151;" data-i18n="settings.model.embeddingModel">
                                    Embedding Model:
                                </label>
                                <div style="font-family: Monaco, monospace; color: #0081BA; font-size: 14px; font-weight: 600;">
                                    gemini-embedding-001
                                </div>
                                <p style="margin: 4px 0 0 0; font-size: 12px; color: #6B7280;" data-i18n="settings.model.embeddingModelDesc">
                                    Usado autom√°ticamente para indexar documentos
                                </p>
                            </div>
                        </div>

                        <div style="background: #F9FAFB; padding: 16px; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #374151;" data-i18n="settings.model.metadataModel">
                                üè∑Ô∏è Modelo para Generaci√≥n de Metadatos con IA:
                            </label>
                            <select id="metadataModelSelector" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 13px; margin-bottom: 8px;">
                                <option value="gemini-2.5-flash">gemini-2.5-flash (R√°pido y econ√≥mico - Recomendado)</option>
                                <option value="gemini-2.5-pro">gemini-2.5-pro (M√°s preciso, m√°s caro)</option>
                                <option value="gemini-1.5-flash">gemini-1.5-flash (Versi√≥n anterior r√°pida)</option>
                                <option value="gemini-1.5-pro">gemini-1.5-pro (Versi√≥n anterior precisa)</option>
                            </select>
                            <button onclick="saveMetadataModelPreference()" class="btn btn-primary" style="width: 100%; padding: 10px;" data-i18n="settings.model.savePreference">
                                üíæ Guardar Preferencia
                            </button>
                            <p style="margin: 8px 0 0 0; font-size: 12px; color: #6B7280;" data-i18n="settings.model.metadataModelDesc">
                                Este modelo se usar√° cuando le des a "‚ú® Analizar con IA" para sugerir metadatos autom√°ticamente
                            </p>
                        </div>
                    </div>

                    <!-- App Info -->
                    <div>
                        <h3 style="font-size: 18px; margin-bottom: 16px; color: #111827;" data-i18n="settings.info.title">‚ÑπÔ∏è Informaci√≥n de la Aplicaci√≥n</h3>

                        <div style="background: #F9FAFB; padding: 16px; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <div>
                                    <strong style="display: block; color: #6B7280; font-size: 13px; margin-bottom: 4px;" data-i18n="settings.info.version">Versi√≥n:</strong>
                                    <div style="color: #111827; font-size: 14px;">1.0.0</div>
                                </div>
                                <div>
                                    <strong style="display: block; color: #6B7280; font-size: 13px; margin-bottom: 4px;" data-i18n="settings.info.framework">Framework:</strong>
                                    <div style="color: #111827; font-size: 14px;">Flask + Gemini File Search</div>
                                </div>
                                <div>
                                    <strong style="display: block; color: #6B7280; font-size: 13px; margin-bottom: 4px;" data-i18n="settings.info.developer">Desarrollado por:</strong>
                                    <div style="color: #111827; font-size: 14px;">
                                        <a href="https://webcomunica.solutions/" target="_blank" style="color: #0081BA; text-decoration: none;">
                                            Webcomunica Solutions
                                        </a>
                                    </div>
                                </div>
                                <div>
                                    <strong style="display: block; color: #6B7280; font-size: 13px; margin-bottom: 4px;" data-i18n="settings.info.server">Servidor:</strong>
                                    <div style="color: #111827; font-size: 14px;" id="serverStatus">Running on localhost:5001</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Docs & Help Tab -->
        <div id="docs-tab" class="tab-content">
            <div class="api-docs-container" id="apiDocsContainer">
                <div class="no-store-message">
                    <h3>Loading Documentation...</h3>
                </div>
            </div>
        </div>

        <!-- Footer minimalista -->
        <footer>
            <div class="footer-content">
                <!-- Logos de las empresas -->
                <div class="footer-logos">
                    <a href="https://webcomunica.solutions/" target="_blank" class="logo-link" title="Webcomunica Solutions">
                        <img src="/static/images/webcomunica.png" alt="Webcomunica Solutions">
                    </a>
                    <a href="https://www.optimizaconia.es/" target="_blank" class="logo-link" title="Optimizaconia">
                        <img src="/static/images/optimizaconia.png" alt="Optimizaconia">
                    </a>
                </div>

                <!-- Redes sociales (solo iconos) -->
                <div class="footer-social">
                    <a href="https://github.com/webcomunicasolutions/" target="_blank" class="social-link" title="GitHub">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                    </a>
                    <a href="https://www.instagram.com/webcomunica_soluciones/" target="_blank" class="social-link" title="Instagram">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                    </a>
                    <a href="https://www.linkedin.com/in/juan-jos%C3%A9-s%C3%A1nchez-bernal-6292a925/" target="_blank" class="social-link" title="LinkedIn">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                    </a>
                </div>
            </div>

            <div class="footer-bottom">
                <p>¬© 2025 Webcomunica Solutions & Optimizaconia ¬∑ Powered by Gemini File Search API</p>
            </div>
        </footer>
    </div>

    <script>
        // ==========================================
        // TRANSLATIONS / TRADUCCIONES
        // ==========================================
        const translations = {
            es: {
                // Header
                'header.subtitle': 'Sube documentos y chatea con tus archivos usando b√∫squeda potenciada por IA',
                'header.inspiration': 'Inspirado por el tutorial de Mark Kashef',

                // Tabs
                'tabs.upload': 'üì§ Upload',
                'tabs.chat': 'üí¨ Chat',
                'tabs.stores': 'üì¶ File Stores',
                'tabs.settings': '‚öôÔ∏è Settings',
                'tabs.docs': 'üìö Docs & Help',

                // Upload - Stores
                'upload.stores.title': 'üì¶ Stores',
                'upload.stores.subtitle': 'Gestiona tus File Search Stores',
                'upload.stores.newName': 'Nombre del nuevo store:',
                'upload.stores.placeholder': 'Ej: Docs 2024',
                'upload.stores.create': '‚ûï Crear Store',
                'upload.stores.view': 'üìã Ver Stores Disponibles',
                'upload.stores.hide': 'üìã Ocultar Stores',
                'upload.stores.noStores': 'No hay stores creados. Crea uno arriba.',

                // Upload - Documents
                'upload.docs.title': 'üì§ Upload Documentos',
                'upload.docs.subtitle': 'Selecciona archivos y elige a qu√© store subirlos',
                'upload.docs.dropZone': 'Arrastra archivos aqu√≠ o haz click para seleccionar',
                'upload.docs.dropZoneSub': 'o haz click para navegar (m√∫ltiples archivos)',
                'upload.docs.uploadAll': 'üì§ Subir Todos los Archivos',

                // Upload - Queue
                'upload.queue.title': 'üìã Archivos en cola',
                'upload.queue.clear': 'üóëÔ∏è Limpiar cola',

                // Upload - Metadata
                'upload.metadata.title': 'üè∑Ô∏è Agregar Metadatos (Opcional)',
                'upload.metadata.addField': '‚ûï Agregar campo',
                'upload.metadata.description': 'Los metadatos te ayudan a identificar y filtrar tus documentos. M√°ximo 20 campos.',
                'upload.metadata.templateLabel': 'üìã Usar plantilla predefinida:',
                'upload.metadata.templateSelect': '-- Selecciona un tipo de documento --',
                'upload.metadata.templateInvoice': 'üìÑ Factura',
                'upload.metadata.templateContract': 'üìù Contrato',
                'upload.metadata.templateReport': 'üìä Informe',
                'upload.metadata.templateManual': 'üìñ Manual/Gu√≠a',
                'upload.metadata.templatePresentation': 'üìΩÔ∏è Presentaci√≥n',
                'upload.metadata.templateMinutes': 'üìã Acta/Minuta',
                'upload.metadata.templateCertificate': 'üéì Certificado',
                'upload.metadata.templateEmail': '‚úâÔ∏è Email/Comunicaci√≥n',
                'upload.metadata.aiTitle': 'ü§ñ Sugerencias Inteligentes con IA',
                'upload.metadata.aiDescription': 'Gemini analizar√° tu documento y sugerir√° metadatos autom√°ticamente',
                'upload.metadata.aiButton': '‚ú® Analizar Documento y Sugerir Metadatos',
                'upload.metadata.chunkingTitle': 'üî™ Configuraci√≥n Avanzada de Chunking',
                'upload.metadata.chunkingMaxTokens': 'Tokens m√°ximos por chunk:',
                'upload.metadata.chunkingOverlap': 'Tokens de solapamiento:',
                'upload.metadata.modalTitle': 'üè∑Ô∏è Configurar Metadatos',
                'upload.metadata.modalSave': 'üíæ Guardar Metadatos',
                'upload.metadata.modalCancel': 'Cancelar',
                'upload.metadata.configured': 'Metadatos Configurados',
                'upload.metadata.label': 'Metadatos:',
                'upload.metadata.editButton': '‚úèÔ∏è Editar Metadatos',
                'upload.metadata.savedNotification': 'Metadatos guardados para',
                'upload.metadata.updatedNotification': 'Metadatos actualizados correctamente',

                // Chat
                'chat.storeActive': 'üì¶ Store Activo',
                'chat.selectStore': 'Selecciona el store para chatear',
                'chat.selectStoreOption': '-- Selecciona un store --',
                'chat.title': 'üí¨ Chat con tus Documentos',
                'chat.emptyState': 'Selecciona un store para comenzar',
                'chat.storeReady': '¬°Store listo! Haz una pregunta sobre tus documentos',
                'chat.documentsActive': 'documentos activos',
                'chat.storeSelected': 'Store seleccionado',
                'chat.placeholder': 'Haz una pregunta...',
                'chat.send': 'Enviar',
                'chat.filters.title': 'üîç Filtrar por metadatos:',
                'chat.filters.add': '‚ûï Agregar filtro',
                'chat.filters.tooltip': 'Filtrar por metadatos',

                // Stores Tab
                'stores.title': 'üì¶ Todos los File Stores',
                'stores.viewDocuments': '‚ñº Ver Documentos',
                'stores.hideDocuments': '‚ñ≤ Ocultar Documentos',
                'stores.deleteStore': 'üóëÔ∏è Eliminar Store',
                'stores.activeDocuments': 'documentos activos',
                'stores.pendingDocuments': 'documentos pendientes',
                'stores.noDocuments': 'Sin documentos',
                'stores.editMetadata': '‚úèÔ∏è Editar Metadatos',
                'stores.deleteDocument': 'üóëÔ∏è Eliminar',
                'stores.state.active': '‚úÖ Activo',
                'stores.state.pending': '‚è≥ Pendiente',
                'stores.state.failed': '‚ùå Error',
                'stores.noMetadata': 'Sin metadatos',
                'stores.noDocumentsInStore': 'No hay documentos en este store',

                // Settings
                'settings.title': '‚öôÔ∏è Settings',
                'settings.subtitle': 'Configura tu aplicaci√≥n RAG',

                // Settings - API Key
                'settings.apiKey.title': 'üîë API Key de Gemini',
                'settings.apiKey.warningTitle': '‚ö†Ô∏è Aviso de Seguridad',
                'settings.apiKey.warningText': 'Nunca compartas tu API key p√∫blicamente. No la subas a GitHub ni la expongas en c√≥digo del lado del cliente.',
                'settings.apiKey.current': 'API Key Actual:',
                'settings.apiKey.update': 'Actualizar API Key:',
                'settings.apiKey.inputPlaceholder': 'Ingresa nueva API key...',
                'settings.apiKey.updateBtn': 'Actualizar Key',
                'settings.apiKey.getKey': 'üí° Obt√©n tu API key en',

                // Settings - Model
                'settings.model.title': 'ü§ñ Configuraci√≥n del Modelo',
                'settings.model.chatModel': 'Modelo para Chat:',
                'settings.model.chatModelDesc': 'Modelo optimizado para RAG con File Search',
                'settings.model.embeddingModel': 'Embedding Model:',
                'settings.model.embeddingModelDesc': 'Usado autom√°ticamente para indexar documentos',
                'settings.model.metadataModel': 'üè∑Ô∏è Modelo para Generaci√≥n de Metadatos con IA:',
                'settings.model.savePreference': 'üíæ Guardar Preferencia',
                'settings.model.metadataModelDesc': 'Este modelo se usar√° cuando le des a "‚ú® Analizar con IA" para sugerir metadatos autom√°ticamente',

                // Settings - Info
                'settings.info.title': '‚ÑπÔ∏è Informaci√≥n de la Aplicaci√≥n',
                'settings.info.version': 'Versi√≥n:',
                'settings.info.framework': 'Framework:',
                'settings.info.developer': 'Desarrollado por:',
                'settings.info.server': 'Servidor:',

                // Docs - HTTP Generator
                'docs.generator.title': 'üîß Generador de Peticiones HTTP',
                'docs.generator.subtitle': 'Configura y genera peticiones HTTP listas para usar en n8n, Make.com, Postman o cualquier cliente',
                'docs.generator.selectOperation': 'Selecciona la Operaci√≥n',
                'docs.generator.configureParams': 'Configura los Par√°metros',
                'docs.generator.chooseFormat': 'Elige el Formato',
                'docs.generator.copyCode': 'Copia el C√≥digo',
                'docs.generator.copyCodeBtn': 'üìã Copiar C√≥digo',
                'docs.generator.copied': '‚úÖ Copiado!',
                'docs.generator.quickGuide': 'üìö Gu√≠a R√°pida',
                'docs.generator.yourApiKey': 'üîë Tu API Key',
                'docs.generator.apiKeyLabel': 'API Key actual:',
                'docs.generator.baseEndpoint': '‚ö° Endpoint Base',
                'docs.generator.documentation': 'üìñ Documentaci√≥n',

                // Docs - Operations
                'docs.operations.createStore': 'Crear Store',
                'docs.operations.createStoreDesc': 'Nuevo File Search Store',
                'docs.operations.listStores': 'Listar Stores',
                'docs.operations.listStoresDesc': 'Ver todos los stores',
                'docs.operations.uploadDocument': 'Subir Documento',
                'docs.operations.uploadDocumentDesc': 'Upload a File Search Store',
                'docs.operations.chatRag': 'Chat RAG',
                'docs.operations.chatRagDesc': 'Consultar documentos',
                'docs.operations.listDocuments': 'Listar Documentos',
                'docs.operations.listDocumentsDesc': 'Ver docs de un store',
                'docs.operations.deleteDocument': 'Eliminar Documento',
                'docs.operations.deleteDocumentDesc': 'Borrar de un store',
                'docs.operations.deleteStore': 'Eliminar Store',
                'docs.operations.deleteStoreDesc': 'Borrar File Search Store',
                'docs.operations.getOperation': 'Estado Operaci√≥n',
                'docs.operations.getOperationDesc': 'Verificar operaci√≥n async',

                // Docs - Form Parameters
                'docs.params.storeName': 'Nombre del Store:',
                'docs.params.storeNameHelp': 'Nombre descriptivo para tu store',
                'docs.params.noParams': 'Esta operaci√≥n no requiere par√°metros adicionales.',
                'docs.params.targetStore': 'üì¶ Store Destino:',
                'docs.params.fileName': 'üìÑ Nombre del Archivo:',
                'docs.params.mimeType': 'Tipo MIME:',
                'docs.params.storeToQuery': 'üì¶ Store a Consultar:',
                'docs.params.yourQuestion': 'üí¨ Tu Pregunta:',
                'docs.params.model': 'ü§ñ Modelo:',
                'docs.params.store': 'üì¶ Store:',
                'docs.params.documentId': 'üìÑ ID del Documento:',
                'docs.params.documentIdHelp': 'Lo obtienes al listar documentos',
                'docs.params.storeToDelete': 'üì¶ Store a Eliminar:',
                'docs.params.deleteWarning': '‚ö†Ô∏è Esta acci√≥n es irreversible y eliminar√° todos los documentos del store.',
                'docs.params.operationId': 'ID de la Operaci√≥n:',
                'docs.params.operationIdHelp': 'Lo obtienes al crear/subir documentos',
                'docs.params.questionPlaceholder': '¬øCu√°les son los puntos principales de los documentos?',

                // Docs - Explanations
                'docs.explain.title': 'üìñ Explicaci√≥n:',
                'docs.explain.createStore': 'Crea un nuevo File Search Store. El nombre debe ser descriptivo y √∫nico. La API devolver√° un ID auto-generado.',
                'docs.explain.listStores': 'Lista todos tus File Search Stores. Usa pageSize para controlar cu√°ntos stores obtener por p√°gina (m√°ximo 20).',
                'docs.explain.uploadDocument': 'Upload de documento en 2 pasos: primero obtener la URL de upload resumable, luego subir el archivo binario. El documento se procesar√° autom√°ticamente (chunking + embedding).',
                'docs.explain.chatRag': 'Consulta RAG: el modelo buscar√° en el store especificado y generar√° una respuesta fundamentada en los documentos. Las citaciones estar√°n en groundingMetadata.',
                'docs.explain.listDocuments': 'Lista todos los documentos de un store espec√≠fico. Muestra estado (PENDING, ACTIVE, FAILED) y metadata de cada documento.',
                'docs.explain.deleteDocument': 'Elimina un documento y todos sus chunks del store. force=true elimina tambi√©n objetos relacionados.',
                'docs.explain.deleteStore': '‚ö†Ô∏è CUIDADO: Elimina el store completo con todos sus documentos y chunks. force=true es requerido para eliminaci√≥n completa.',
                'docs.explain.getOperation': 'Verifica el estado de una operaci√≥n as√≠ncrona (upload, import). Cuando done=true, revisar error o response.',
                'docs.quickStart.title': 'üöÄ Gu√≠a de Inicio R√°pido',
                'docs.quickStart.subtitle': 'Aprende a usar Gemini File Search Manager en 3 simples pasos',

                // Notifications
                'notification.success': '‚úÖ',
                'notification.error': '‚ùå',
                'notification.info': '‚ÑπÔ∏è'
            },
            en: {
                // Header
                'header.subtitle': 'Upload documents and chat with your files using AI-powered search',
                'header.inspiration': 'Inspired by Mark Kashef's tutorial',

                // Tabs
                'tabs.upload': 'üì§ Upload',
                'tabs.chat': 'üí¨ Chat',
                'tabs.stores': 'üì¶ File Stores',
                'tabs.settings': '‚öôÔ∏è Settings',
                'tabs.docs': 'üìö Docs & Help',

                // Upload - Stores
                'upload.stores.title': 'üì¶ Stores',
                'upload.stores.subtitle': 'Manage your File Search Stores',
                'upload.stores.newName': 'New store name:',
                'upload.stores.placeholder': 'e.g. Docs 2024',
                'upload.stores.create': '‚ûï Create Store',
                'upload.stores.view': 'üìã View Available Stores',
                'upload.stores.hide': 'üìã Hide Stores',
                'upload.stores.noStores': 'No stores created. Create one above.',

                // Upload - Documents
                'upload.docs.title': 'üì§ Upload Documents',
                'upload.docs.subtitle': 'Select files and choose which store to upload to',
                'upload.docs.dropZone': 'Drag & drop your files here',
                'upload.docs.dropZoneSub': 'or click to browse (multiple files)',
                'upload.docs.uploadAll': 'üì§ Upload All Files',

                // Upload - Queue
                'upload.queue.title': 'üìã Files in queue',
                'upload.queue.clear': 'üóëÔ∏è Clear queue',

                // Upload - Metadata
                'upload.metadata.title': 'üè∑Ô∏è Add Metadata (Optional)',
                'upload.metadata.addField': '‚ûï Add field',
                'upload.metadata.description': 'Metadata helps you identify and filter your documents. Maximum 20 fields.',
                'upload.metadata.templateLabel': 'üìã Use predefined template:',
                'upload.metadata.templateSelect': '-- Select a document type --',
                'upload.metadata.templateInvoice': 'üìÑ Invoice',
                'upload.metadata.templateContract': 'üìù Contract',
                'upload.metadata.templateReport': 'üìä Report',
                'upload.metadata.templateManual': 'üìñ Manual/Guide',
                'upload.metadata.templatePresentation': 'üìΩÔ∏è Presentation',
                'upload.metadata.templateMinutes': 'üìã Minutes/Meeting Notes',
                'upload.metadata.templateCertificate': 'üéì Certificate',
                'upload.metadata.templateEmail': '‚úâÔ∏è Email/Communication',
                'upload.metadata.aiTitle': 'ü§ñ AI Smart Suggestions',
                'upload.metadata.aiDescription': 'Gemini will analyze your document and suggest metadata automatically',
                'upload.metadata.aiButton': '‚ú® Analyze Document and Suggest Metadata',
                'upload.metadata.chunkingTitle': 'üî™ Advanced Chunking Configuration',
                'upload.metadata.chunkingMaxTokens': 'Maximum tokens per chunk:',
                'upload.metadata.chunkingOverlap': 'Overlap tokens:',
                'upload.metadata.modalTitle': 'üè∑Ô∏è Configure Metadata',
                'upload.metadata.modalSave': 'üíæ Save Metadata',
                'upload.metadata.modalCancel': 'Cancel',
                'upload.metadata.configured': 'Metadata Configured',
                'upload.metadata.label': 'Metadata:',
                'upload.metadata.editButton': '‚úèÔ∏è Edit Metadata',
                'upload.metadata.savedNotification': 'Metadata saved for',
                'upload.metadata.updatedNotification': 'Metadata updated successfully',

                // Chat
                'chat.storeActive': 'üì¶ Active Store',
                'chat.selectStore': 'Select store to chat',
                'chat.selectStoreOption': '-- Select a store --',
                'chat.title': 'üí¨ Chat with Your Documents',
                'chat.emptyState': 'Select a store to begin',
                'chat.storeReady': 'Store ready! Ask a question about your documents',
                'chat.documentsActive': 'active documents',
                'chat.storeSelected': 'Store selected',
                'chat.placeholder': 'Ask a question...',
                'chat.send': 'Send',
                'chat.filters.title': 'üîç Filter by metadata:',
                'chat.filters.add': '‚ûï Add filter',
                'chat.filters.tooltip': 'Filter by metadata',

                // Stores Tab
                'stores.title': 'üì¶ All File Stores',
                'stores.viewDocuments': '‚ñº View Documents',
                'stores.hideDocuments': '‚ñ≤ Hide Documents',
                'stores.deleteStore': 'üóëÔ∏è Delete Store',
                'stores.activeDocuments': 'active documents',
                'stores.pendingDocuments': 'pending documents',
                'stores.noDocuments': 'No documents',
                'stores.editMetadata': '‚úèÔ∏è Edit Metadata',
                'stores.deleteDocument': 'üóëÔ∏è Delete',
                'stores.state.active': '‚úÖ Active',
                'stores.state.pending': '‚è≥ Pending',
                'stores.state.failed': '‚ùå Failed',
                'stores.noMetadata': 'No metadata',
                'stores.noDocumentsInStore': 'No documents in this store',

                // Settings
                'settings.title': '‚öôÔ∏è Settings',
                'settings.subtitle': 'Configure your RAG application',

                // Settings - API Key
                'settings.apiKey.title': 'üîë Gemini API Key',
                'settings.apiKey.warningTitle': '‚ö†Ô∏è Security Warning',
                'settings.apiKey.warningText': 'Never share your API key publicly. Do not upload it to GitHub or expose it in client-side code.',
                'settings.apiKey.current': 'Current API Key:',
                'settings.apiKey.update': 'Update API Key:',
                'settings.apiKey.inputPlaceholder': 'Enter new API key...',
                'settings.apiKey.updateBtn': 'Update Key',
                'settings.apiKey.getKey': 'üí° Get your API key at',

                // Settings - Model
                'settings.model.title': 'ü§ñ Model Configuration',
                'settings.model.chatModel': 'Chat Model:',
                'settings.model.chatModelDesc': 'Optimized model for RAG with File Search',
                'settings.model.embeddingModel': 'Embedding Model:',
                'settings.model.embeddingModelDesc': 'Automatically used to index documents',
                'settings.model.metadataModel': 'üè∑Ô∏è Model for AI Metadata Generation:',
                'settings.model.savePreference': 'üíæ Save Preference',
                'settings.model.metadataModelDesc': 'This model will be used when you click "‚ú® Analyze with AI" to automatically suggest metadata',

                // Settings - Info
                'settings.info.title': '‚ÑπÔ∏è Application Information',
                'settings.info.version': 'Version:',
                'settings.info.framework': 'Framework:',
                'settings.info.developer': 'Developed by:',
                'settings.info.server': 'Server:',

                // Docs - HTTP Generator
                'docs.generator.title': 'üîß HTTP Request Generator',
                'docs.generator.subtitle': 'Configure and generate HTTP requests ready to use in n8n, Make.com, Postman or any client',
                'docs.generator.selectOperation': 'Select Operation',
                'docs.generator.configureParams': 'Configure Parameters',
                'docs.generator.chooseFormat': 'Choose Format',
                'docs.generator.copyCode': 'Copy Code',
                'docs.generator.copyCodeBtn': 'üìã Copy Code',
                'docs.generator.copied': '‚úÖ Copied!',
                'docs.generator.quickGuide': 'üìö Quick Guide',
                'docs.generator.yourApiKey': 'üîë Your API Key',
                'docs.generator.apiKeyLabel': 'Current API Key:',
                'docs.generator.baseEndpoint': '‚ö° Base Endpoint',
                'docs.generator.documentation': 'üìñ Documentation',

                // Docs - Operations
                'docs.operations.createStore': 'Create Store',
                'docs.operations.createStoreDesc': 'New File Search Store',
                'docs.operations.listStores': 'List Stores',
                'docs.operations.listStoresDesc': 'View all stores',
                'docs.operations.uploadDocument': 'Upload Document',
                'docs.operations.uploadDocumentDesc': 'Upload to File Search Store',
                'docs.operations.chatRag': 'Chat RAG',
                'docs.operations.chatRagDesc': 'Query documents',
                'docs.operations.listDocuments': 'List Documents',
                'docs.operations.listDocumentsDesc': 'View store documents',
                'docs.operations.deleteDocument': 'Delete Document',
                'docs.operations.deleteDocumentDesc': 'Remove from store',
                'docs.operations.deleteStore': 'Delete Store',
                'docs.operations.deleteStoreDesc': 'Delete File Search Store',
                'docs.operations.getOperation': 'Operation Status',
                'docs.operations.getOperationDesc': 'Check async operation',

                // Docs - Form Parameters
                'docs.params.storeName': 'Store Name:',
                'docs.params.storeNameHelp': 'Descriptive name for your store',
                'docs.params.noParams': 'This operation does not require additional parameters.',
                'docs.params.targetStore': 'üì¶ Target Store:',
                'docs.params.fileName': 'üìÑ File Name:',
                'docs.params.mimeType': 'MIME Type:',
                'docs.params.storeToQuery': 'üì¶ Store to Query:',
                'docs.params.yourQuestion': 'üí¨ Your Question:',
                'docs.params.model': 'ü§ñ Model:',
                'docs.params.store': 'üì¶ Store:',
                'docs.params.documentId': 'üìÑ Document ID:',
                'docs.params.documentIdHelp': 'Obtained when listing documents',
                'docs.params.storeToDelete': 'üì¶ Store to Delete:',
                'docs.params.deleteWarning': '‚ö†Ô∏è This action is irreversible and will delete all documents in the store.',
                'docs.params.operationId': 'Operation ID:',
                'docs.params.operationIdHelp': 'Obtained when creating/uploading documents',
                'docs.params.questionPlaceholder': 'What are the main points of the documents?',

                // Docs - Explanations
                'docs.explain.title': 'üìñ Explanation:',
                'docs.explain.createStore': 'Creates a new File Search Store. The name should be descriptive and unique. The API will return an auto-generated ID.',
                'docs.explain.listStores': 'Lists all your File Search Stores. Use pageSize to control how many stores to retrieve per page (maximum 20).',
                'docs.explain.uploadDocument': 'Document upload in 2 steps: first get the resumable upload URL, then upload the binary file. The document will be automatically processed (chunking + embedding).',
                'docs.explain.chatRag': 'RAG query: the model will search in the specified store and generate a response grounded in the documents. Citations will be in groundingMetadata.',
                'docs.explain.listDocuments': 'Lists all documents in a specific store. Shows status (PENDING, ACTIVE, FAILED) and metadata for each document.',
                'docs.explain.deleteDocument': 'Deletes a document and all its chunks from the store. force=true also deletes related objects.',
                'docs.explain.deleteStore': '‚ö†Ô∏è WARNING: Deletes the complete store with all its documents and chunks. force=true is required for complete deletion.',
                'docs.explain.getOperation': 'Checks the status of an asynchronous operation (upload, import). When done=true, check error or response.',
                'docs.quickStart.title': 'üöÄ Quick Start Guide',
                'docs.quickStart.subtitle': 'Learn how to use Gemini File Search Manager in 3 simple steps',

                // Notifications
                'notification.success': '‚úÖ',
                'notification.error': '‚ùå',
                'notification.info': '‚ÑπÔ∏è'
            }
        };

        // Current language
        let currentLang = localStorage.getItem('language') || 'es';

        // Change language function
        window.changeLanguage = function(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);

            // Update all elements with data-i18n attribute (text content)
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });

            // Update titles
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (translations[lang][key]) {
                    el.title = translations[lang][key];
                }
            });

            // Update language buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#6B7280';
                btn.style.borderColor = '#D1D5DB';
            });

            const activeBtn = document.getElementById(`lang-${lang}`);
            if (activeBtn) {
                activeBtn.style.background = '#0081BA';
                activeBtn.style.color = 'white';
                activeBtn.style.borderColor = '#0081BA';
            }

            // Reload current tab content if needed
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && activeTab.id === 'docs-tab') {
                loadApiDocumentation();
            }
        }

        // Get translation helper function
        window.t = function(key) {
            return translations[currentLang][key] || key;
        }

        // Initialize variables
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        let fileUploaded = false;
        let apiInfoCache = null;

        // Load stores list on page load
        async function loadStoresList() {
            const container = document.getElementById('storesListContainer');
            if (!container) return;

            try {
                const response = await fetch('/stores');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al cargar stores');
                }

                if (!data.stores || data.stores.length === 0) {
                    container.innerHTML = '<div style="color: #9CA3AF; font-size: 13px;">No hay stores creados. Crea uno arriba.</div>';
                    return;
                }

                const storesHTML = data.stores.map(store => `
                    <div style="background: #EFF6FF; color: #1E40AF; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 500; border: 1px solid #BFDBFE;">
                        üì¶ ${store.display_name || store.name}
                        <span style="color: #6B7280; font-weight: 400; margin-left: 4px;">(${store.active_documents_count || 0} docs)</span>
                    </div>
                `).join('');

                container.innerHTML = storesHTML;

            } catch (error) {
                console.error('Error loading stores:', error);
                container.innerHTML = '<div style="color: #EF4444; font-size: 13px;">Error al cargar stores</div>';
            }
        }

        // Create new store
        document.getElementById('createStoreBtn')?.addEventListener('click', async () => {
            const nameInput = document.getElementById('newStoreName');
            const storeName = nameInput.value.trim();

            if (!storeName) {
                showNotification('‚ùå Por favor, ingresa un nombre para el store', 'error');
                return;
            }

            const btn = document.getElementById('createStoreBtn');
            btn.disabled = true;
            btn.textContent = 'Creando...';

            try {
                const response = await fetch('/create-store', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ display_name: storeName })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al crear store');
                }

                showNotification(`‚úÖ Store "${storeName}" creado correctamente`, 'success');
                nameInput.value = '';

                // Reload stores list if visible
                if (storesListLoaded) {
                    await loadStoresList();
                }

                // Reload chat stores selector
                await loadChatStores();

                // Reload files queue to update selectors
                if (filesQueue.length > 0) {
                    await renderFilesQueue();
                }

            } catch (error) {
                showNotification(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ûï Crear Store';
            }
        });

        // Toggle stores list visibility in upload tab
        let storesListLoaded = false;
        document.getElementById('toggleStoresListBtn')?.addEventListener('click', async function() {
            const storesList = document.getElementById('currentStoresList');
            const btn = this;

            if (storesList.style.display === 'none') {
                // Show stores list
                storesList.style.display = 'block';
                btn.textContent = 'üìã Ocultar Stores';

                // Load stores only on first click
                if (!storesListLoaded) {
                    await loadStoresList();
                    storesListLoaded = true;
                }
            } else {
                // Hide stores list
                storesList.style.display = 'none';
                btn.textContent = 'üìã Ver Stores Disponibles';
            }
        });

        // Load stores for chat selector
        async function loadChatStores() {
            const selector = document.getElementById('chatStoreSelector');
            if (!selector) return;

            try {
                const response = await fetch('/stores');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al cargar stores');
                }

                // Clear and populate selector
                selector.innerHTML = '<option value="">-- Selecciona un store --</option>';

                if (data.stores && data.stores.length > 0) {
                    data.stores.forEach(store => {
                        const option = document.createElement('option');
                        option.value = store.name;
                        option.textContent = `${store.display_name || store.name} (${store.active_documents_count || 0} docs)`;
                        selector.appendChild(option);
                    });
                }

            } catch (error) {
                console.error('Error loading chat stores:', error);
            }
        }

        // Handle chat store selection
        document.getElementById('chatStoreSelector')?.addEventListener('change', async function() {
            const storeName = this.value;
            const chatStoreInfo = document.getElementById('chatStoreInfo');
            const chatStoreInfoName = document.getElementById('chatStoreInfoName');
            const chatStoreInfoDocs = document.getElementById('chatStoreInfoDocs');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');

            if (!storeName) {
                chatStoreInfo.style.display = 'none';
                chatInput.disabled = true;
                sendBtn.disabled = true;
                document.getElementById('chatMessages').innerHTML = `<div class="empty-state">${t('chat.emptyState')}</div>`;
                return;
            }

            try {
                // Set the store in the backend
                const response = await fetch('/switch-store', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ store_name: storeName })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al seleccionar store');
                }

                // Show store info
                chatStoreInfoName.textContent = data.store.display_name || data.store.name;
                chatStoreInfoDocs.textContent = `${data.store.active_documents_count || 0} ${t('chat.documentsActive')}`;
                chatStoreInfo.style.display = 'block';

                // Enable chat
                chatInput.disabled = false;
                sendBtn.disabled = false;
                document.getElementById('chatMessages').innerHTML = `<div class="empty-state">${t('chat.storeReady')}</div>`;

                showNotification(`‚úÖ ${t('chat.storeSelected')} "${data.store.display_name || data.store.name}"`, 'success');

            } catch (error) {
                showNotification(`‚ùå Error: ${error.message}`, 'error');
                chatStoreInfo.style.display = 'none';
                chatInput.disabled = true;
                sendBtn.disabled = true;
            }
        });

        // Load stores for chat on page load
        window.addEventListener('load', () => {
            loadChatStores();
        });

        // Drag & drop file upload
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleMultipleFiles(Array.from(e.dataTransfer.files));
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleMultipleFiles(Array.from(e.target.files));
            }
        });

        // Global variables for file queue
        let filesQueue = [];
        let selectedFile = null;
        let metadataFieldsCount = 0;

        // Handle multiple files selection
        function handleMultipleFiles(files) {
            // Add files to queue
            files.forEach(file => {
                const fileId = `file-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                filesQueue.push({
                    id: fileId,
                    file: file,
                    storeName: null,  // Will be selected by user
                    metadata: {}
                });
            });

            renderFilesQueue();
            document.getElementById('filesQueue').style.display = 'block';
        }

        // Render files queue
        async function renderFilesQueue() {
            const container = document.getElementById('filesQueueList');
            const countSpan = document.getElementById('queueCount');

            countSpan.textContent = filesQueue.length;

            if (filesQueue.length === 0) {
                document.getElementById('filesQueue').style.display = 'none';
                return;
            }

            // Get list of stores for selector
            let storesHTML = '<option value="">-- Selecciona un store --</option>';
            try {
                const response = await fetch('/stores');
                const data = await response.json();
                if (data.stores && data.stores.length > 0) {
                    storesHTML += data.stores.map(store =>
                        `<option value="${store.name}">${store.display_name || store.name}</option>`
                    ).join('');
                } else {
                    storesHTML += '<option value="" disabled>No hay stores disponibles - Crea uno arriba</option>';
                }
            } catch (error) {
                console.error('Error loading stores:', error);
            }

            const filesHTML = filesQueue.map((fileItem, index) => `
                <div style="background: white; border: 1px solid #E5E7EB; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #111827; margin-bottom: 4px;">
                                üìÑ ${fileItem.file.name}
                            </div>
                            <div style="font-size: 12px; color: #6B7280;">
                                ${(fileItem.file.size / 1024).toFixed(2)} KB
                            </div>
                        </div>
                        <button onclick="removeFromQueue('${fileItem.id}')"
                            style="padding: 6px 10px; background: #EF4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            ‚ùå
                        </button>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <label style="display: block; font-size: 12px; color: #374151; margin-bottom: 4px; font-weight: 500;">
                            üì¶ Destino del archivo:
                        </label>
                        <select onchange="updateFileStore('${fileItem.id}', this.value)"
                            style="width: 100%; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 13px;">
                            ${storesHTML}
                        </select>
                    </div>
                    <button onclick="configureFileMetadata('${fileItem.id}')"
                        class="btn-secondary"
                        style="width: 100%; padding: 8px; font-size: 13px;"
                        data-i18n="upload.metadata.editButton">
                        üè∑Ô∏è Configurar Metadatos
                    </button>
                </div>
            `).join('');

            container.innerHTML = filesHTML;
        }

        // Remove file from queue
        window.removeFromQueue = function(fileId) {
            filesQueue = filesQueue.filter(f => f.id !== fileId);
            renderFilesQueue();
        };

        // Update file store destination
        window.updateFileStore = function(fileId, storeName) {
            const fileItem = filesQueue.find(f => f.id === fileId);
            if (fileItem) {
                fileItem.storeName = storeName || null;
            }
        };

        // Configure metadata for specific file
        window.configureFileMetadata = function(fileId) {
            const fileItem = filesQueue.find(f => f.id === fileId);
            if (!fileItem) return;

            selectedFile = fileItem.file;
            showMetadataModal(fileItem);
        };

        // Show metadata configuration modal for a file
        function showMetadataModal(fileItem) {
            // Create modal HTML
            const modalHTML = `
                <div class="modal-overlay" id="metadataConfigModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2 style="margin: 0; color: #111827;">${t('upload.metadata.modalTitle')}</h2>
                            <button class="modal-close" id="closeMetadataModal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p style="margin: 0 0 16px 0; font-size: 14px; color: #6B7280;">
                                Archivo: <strong>${fileItem.file.name}</strong>
                            </p>

                            <!-- Templates Selector -->
                            <div style="margin-bottom: 16px; padding: 12px; background: #EFF6FF; border-radius: 8px; border: 1px solid #BFDBFE;">
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #1E40AF;">
                                    ${t('upload.metadata.templateLabel')}
                                </label>
                                <select id="queueMetadataTemplate" style="width: 100%; padding: 8px; border: 1px solid #93C5FD; border-radius: 6px; font-size: 14px; background: white;">
                                    <option value="">${t('upload.metadata.templateSelect')}</option>
                                    <option value="factura">${t('upload.metadata.templateInvoice')}</option>
                                    <option value="contrato">${t('upload.metadata.templateContract')}</option>
                                    <option value="informe">${t('upload.metadata.templateReport')}</option>
                                    <option value="manual">${t('upload.metadata.templateManual')}</option>
                                    <option value="presentacion">${t('upload.metadata.templatePresentation')}</option>
                                    <option value="acta">${t('upload.metadata.templateMinutes')}</option>
                                    <option value="certificado">${t('upload.metadata.templateCertificate')}</option>
                                    <option value="email">${t('upload.metadata.templateEmail')}</option>
                                </select>
                            </div>

                            <!-- AI Suggestions Button -->
                            <div style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%); border-radius: 8px; border: 1px solid #86EFAC;">
                                <label style="font-size: 13px; font-weight: 500; color: #166534; display: block; margin-bottom: 8px;">
                                    ${t('upload.metadata.aiTitle')}
                                </label>
                                <p style="margin: 0 0 12px 0; font-size: 12px; color: #15803D;">
                                    ${t('upload.metadata.aiDescription')}
                                </p>
                                <button id="queueSuggestMetadataBtn" class="btn-secondary" style="width: 100%; padding: 10px; background: #22C55E; color: white; border: none; font-weight: 600;">
                                    ${t('upload.metadata.aiButton')}
                                </button>
                                <div id="queueAiSuggestionStatus" style="margin-top: 8px; font-size: 12px; display: none;"></div>
                            </div>

                            <div id="queueMetadataFields"></div>

                            <button id="queueAddMetadataField" class="btn-secondary" style="width: 100%; margin-top: 12px;">
                                ${t('upload.metadata.addField')}
                            </button>

                            <div style="display: flex; gap: 8px; margin-top: 16px;">
                                <button id="saveQueueMetadata" class="btn btn-primary" style="flex: 1;">
                                    ${t('upload.metadata.modalSave')}
                                </button>
                                <button id="cancelQueueMetadata" class="btn-secondary" style="flex: 1;">
                                    ${t('upload.metadata.modalCancel')}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            const modal = document.getElementById('metadataConfigModal');
            const fieldsContainer = document.getElementById('queueMetadataFields');
            let queueFieldCount = 0;

            // Function to add metadata field
            function addQueueField(key = '', value = '', type = 'string') {
                const fieldId = `queue-metadata-${queueFieldCount++}`;
                const fieldHTML = `
                    <div class="metadata-field" id="${fieldId}" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: start;">
                        <input type="text" value="${key}" placeholder="Clave" class="queue-metadata-key"
                            style="flex: 1; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                        <input type="text" value="${value}" placeholder="Valor" class="queue-metadata-value"
                            style="flex: 1; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                        <select class="queue-metadata-type" style="padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                            <option value="string" ${type === 'string' ? 'selected' : ''}>Texto</option>
                            <option value="number" ${type === 'number' ? 'selected' : ''}>N√∫mero</option>
                        </select>
                        <button onclick="document.getElementById('${fieldId}').remove()" class="btn-secondary" style="padding: 8px 12px; font-size: 12px;">
                            ‚ùå
                        </button>
                    </div>
                `;
                fieldsContainer.insertAdjacentHTML('beforeend', fieldHTML);
            }

            // Pre-populate with existing metadata if any
            if (fileItem.metadata && Object.keys(fileItem.metadata).length > 0) {
                Object.entries(fileItem.metadata).forEach(([key, value]) => {
                    const type = typeof value === 'number' ? 'number' : 'string';
                    addQueueField(key, value, type);
                });
            }

            // Add field button
            document.getElementById('queueAddMetadataField').addEventListener('click', () => {
                addQueueField();
            });

            // Template selector
            document.getElementById('queueMetadataTemplate').addEventListener('change', (e) => {
                const templateName = e.target.value;
                if (!templateName) return;

                const template = metadataTemplates[templateName];
                if (!template) return;

                // Clear existing fields
                fieldsContainer.innerHTML = '';
                queueFieldCount = 0;

                // Add template fields
                template.forEach(field => {
                    addQueueField(field.key, field.value, field.type);
                });
            });

            // AI Suggest Metadata
            document.getElementById('queueSuggestMetadataBtn').addEventListener('click', async () => {
                const btn = document.getElementById('queueSuggestMetadataBtn');
                const status = document.getElementById('queueAiSuggestionStatus');

                btn.disabled = true;
                btn.textContent = 'üîÑ Analizando...';
                status.style.display = 'block';
                status.style.color = '#0081BA';
                status.textContent = 'Gemini est√° analizando tu documento...';

                try {
                    const formData = new FormData();
                    formData.append('file', fileItem.file);

                    // Add model preference
                    const metadataModel = localStorage.getItem('metadata_model') || 'gemini-2.5-flash';
                    formData.append('model', metadataModel);

                    const response = await fetch('/suggest-metadata', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Error al analizar documento');
                    }

                    // Clear existing fields
                    fieldsContainer.innerHTML = '';
                    queueFieldCount = 0;

                    // Add suggested fields
                    const metadataKeys = Object.keys(data.metadata);
                    for (const [key, value] of Object.entries(data.metadata)) {
                        const type = typeof value === 'number' ? 'number' : 'string';
                        addQueueField(key, value, type);
                    }

                    status.style.color = '#22C55E';
                    status.textContent = `‚úÖ IA sugiri√≥ ${metadataKeys.length} metadatos`;

                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);

                } catch (error) {
                    status.style.color = '#EF4444';
                    status.textContent = `‚ùå Error: ${error.message}`;
                } finally {
                    btn.disabled = false;
                    btn.textContent = t('upload.metadata.aiButton');
                }
            });

            // Save metadata
            document.getElementById('saveQueueMetadata').addEventListener('click', () => {
                const metadata = {};
                const fields = fieldsContainer.querySelectorAll('.metadata-field');

                fields.forEach(field => {
                    const key = field.querySelector('.queue-metadata-key').value.trim();
                    const value = field.querySelector('.queue-metadata-value').value.trim();
                    const type = field.querySelector('.queue-metadata-type').value;

                    if (key && value) {
                        metadata[key] = type === 'number' ? parseFloat(value) : value;
                    }
                });

                // Update file item metadata
                fileItem.metadata = metadata;

                // Update UI to show metadata configured
                const fileCard = document.querySelector(`button[onclick*="${fileItem.id}"]`).closest('div[style*="background: white"]');
                if (fileCard) {
                    const metadataBtn = fileCard.querySelector('button[onclick*="configureFileMetadata"]');
                    const count = Object.keys(metadata).length;
                    if (count > 0) {
                        metadataBtn.style.background = '#22C55E';
                        metadataBtn.style.color = 'white';
                        metadataBtn.textContent = `‚úÖ ${count} ${t('upload.metadata.configured')}`;
                    }
                }

                showNotification(`‚úÖ ${t('upload.metadata.savedNotification')} ${fileItem.file.name}`, 'success');
                modal.remove();
            });

            // Cancel
            document.getElementById('cancelQueueMetadata').addEventListener('click', () => {
                modal.remove();
            });

            // Close button
            document.getElementById('closeMetadataModal').addEventListener('click', () => {
                modal.remove();
            });

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Clear all queue
        document.getElementById('clearQueue')?.addEventListener('click', () => {
            if (confirm('¬øEliminar todos los archivos de la cola?')) {
                filesQueue = [];
                renderFilesQueue();
            }
        });

        // Upload all files
        document.getElementById('uploadAllFiles')?.addEventListener('click', async () => {
            if (filesQueue.length === 0) {
                showNotification('‚ùå No hay archivos en la cola', 'error');
                return;
            }

            // Validate that all files have a store selected
            const filesWithoutStore = filesQueue.filter(f => !f.storeName || f.storeName === '');
            if (filesWithoutStore.length > 0) {
                showNotification(`‚ùå Debes seleccionar un store para todos los archivos (${filesWithoutStore.length} sin store)`, 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadAllFiles');
            uploadBtn.disabled = true;
            uploadBtn.textContent = `Subiendo 0/${filesQueue.length}...`;

            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < filesQueue.length; i++) {
                const fileItem = filesQueue[i];

                try {
                    await uploadSingleFile(fileItem);
                    successCount++;
                } catch (error) {
                    console.error(`Error uploading ${fileItem.file.name}:`, error);
                    errorCount++;
                }

                uploadBtn.textContent = `Subiendo ${i + 1}/${filesQueue.length}...`;
            }

            uploadBtn.disabled = false;
            uploadBtn.textContent = 'üì§ Subir Todos los Archivos';

            if (successCount > 0) {
                showNotification(`‚úÖ ${successCount} archivo(s) subido(s) correctamente`, 'success');
            }
            if (errorCount > 0) {
                showNotification(`‚ùå ${errorCount} archivo(s) fallaron`, 'error');
            }

            filesQueue = [];
            renderFilesQueue();
        });

        // Upload single file from queue
        async function uploadSingleFile(fileItem) {
            const formData = new FormData();
            formData.append('file', fileItem.file);

            // Add store name if selected
            if (fileItem.storeName) {
                formData.append('store_name', fileItem.storeName);
            }

            // Add metadata if configured
            if (fileItem.metadata && Object.keys(fileItem.metadata).length > 0) {
                formData.append('metadata', JSON.stringify(fileItem.metadata));
            }

            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Upload failed');
            }

            return await response.json();
        }

        // File upload handler - Show metadata form
        function handleFile(file) {
            selectedFile = file;
            const metadataSection = document.getElementById('metadataSection');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadBtn = document.getElementById('uploadWithMetadata');

            // Show metadata section
            metadataSection.style.display = 'block';
            uploadBtn.style.display = 'block';

            // Show file info
            uploadStatus.innerHTML = `
                <div style="padding: 12px; background: #EFF6FF; border-radius: 8px; margin-top: 12px; border-left: 4px solid #3B82F6;">
                    <p style="margin: 0; color: #1E40AF; font-size: 14px;">
                        üìÑ <strong>Archivo seleccionado:</strong> ${file.name} (${(file.size / 1024).toFixed(2)} KB)
                    </p>
                    <p style="margin: 8px 0 0 0; color: #6B7280; font-size: 13px;">
                        Puedes agregar metadatos para identificar mejor este documento
                    </p>
                </div>
            `;

            // Add initial metadata fields if empty
            if (metadataFieldsCount === 0) {
                addMetadataField();
            }

            // Enable AI suggestions button
            const suggestBtn = document.getElementById('suggestMetadataBtn');
            suggestBtn.disabled = false;
        }

        // AI Metadata Suggestions
        document.getElementById('suggestMetadataBtn').addEventListener('click', async () => {
            if (!selectedFile) {
                showNotification('‚ö†Ô∏è Primero selecciona un archivo', 'info');
                return;
            }

            const suggestBtn = document.getElementById('suggestMetadataBtn');
            const statusDiv = document.getElementById('aiSuggestionStatus');

            try {
                // Disable button and show loading
                suggestBtn.disabled = true;
                suggestBtn.textContent = 'üîÑ Analizando documento...';
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '<div class="loading-spinner"></div><span style="color: #6B7280; margin-left: 8px;">Gemini est√° leyendo tu documento...</span>';

                // Create form data
                const formData = new FormData();
                formData.append('file', selectedFile);

                // Add model preference
                const metadataModel = localStorage.getItem('metadata_model') || 'gemini-2.5-flash';
                formData.append('model', metadataModel);

                // Send to backend
                const response = await fetch('/suggest-metadata', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al analizar documento');
                }

                // Clear existing metadata fields
                document.getElementById('metadataFields').innerHTML = '';
                metadataFieldsCount = 0;

                // Add suggested metadata fields
                const suggestedMetadata = data.metadata;
                const metadataKeys = Object.keys(suggestedMetadata);

                if (metadataKeys.length === 0) {
                    statusDiv.innerHTML = '<span style="color: #D97706;">‚ö†Ô∏è No se encontraron metadatos relevantes</span>';
                    addMetadataField();
                } else {
                    // Add each suggested field
                    for (const [key, value] of Object.entries(suggestedMetadata)) {
                        addMetadataFieldWithValue(key, value, 'string');
                    }

                    statusDiv.innerHTML = `
                        <span style="color: #059669;">‚úÖ ${metadataKeys.length} metadatos sugeridos!</span>
                        <span style="font-size: 11px; color: #6B7280; display: block; margin-top: 4px;">
                            Puedes editarlos o agregar m√°s campos
                        </span>
                    `;
                    showNotification(`‚ú® IA sugiri√≥ ${metadataKeys.length} metadatos`, 'success');
                }

                // Re-enable button
                suggestBtn.disabled = false;
                suggestBtn.textContent = t('upload.metadata.aiButton');

                // Hide status after 5 seconds
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);

            } catch (error) {
                console.error('Error suggesting metadata:', error);
                statusDiv.innerHTML = `<span style="color: #DC2626;">‚ùå ${error.message}</span>`;
                showNotification(`‚ùå Error: ${error.message}`, 'error');

                // Re-enable button
                suggestBtn.disabled = false;
                suggestBtn.textContent = t('upload.metadata.aiButton');
            }
        });

        // Add metadata field
        function addMetadataField() {
            if (metadataFieldsCount >= 20) {
                alert('‚ö†Ô∏è M√°ximo 20 campos de metadatos permitidos');
                return;
            }

            const metadataFields = document.getElementById('metadataFields');
            const fieldId = `metadata-${metadataFieldsCount++}`;

            const fieldHTML = `
                <div class="metadata-field" id="${fieldId}" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: start;">
                    <input type="text" placeholder="Clave (ej: autor, categor√≠a)" class="metadata-key"
                        style="flex: 1; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                    <input type="text" placeholder="Valor" class="metadata-value"
                        style="flex: 1; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                    <select class="metadata-type" style="padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                        <option value="string">Texto</option>
                        <option value="number">N√∫mero</option>
                    </select>
                    <button onclick="removeMetadataField('${fieldId}')" class="btn-secondary" style="padding: 8px 12px; font-size: 12px;">
                        ‚ùå
                    </button>
                </div>
            `;

            metadataFields.insertAdjacentHTML('beforeend', fieldHTML);
        }

        // Remove metadata field
        function removeMetadataField(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.remove();
                metadataFieldsCount--;
            }
        }

        // Upload file with metadata
        async function uploadFileWithMetadata() {
            if (!selectedFile) {
                alert('‚ö†Ô∏è Por favor selecciona un archivo primero');
                return;
            }

            const uploadBtn = document.getElementById('uploadWithMetadata');
            const uploadStatus = document.getElementById('uploadStatus');

            // Collect metadata
            const metadata = {};
            const metadataFields = document.querySelectorAll('.metadata-field');
            metadataFields.forEach(field => {
                const key = field.querySelector('.metadata-key').value.trim();
                const value = field.querySelector('.metadata-value').value.trim();
                const type = field.querySelector('.metadata-type').value;

                if (key && value) {
                    metadata[key] = type === 'number' ? parseFloat(value) : value;
                }
            });

            // Collect chunking config
            const chunkingConfig = {
                enabled: document.getElementById('enableChunking').checked
            };
            if (chunkingConfig.enabled) {
                chunkingConfig.max_tokens_per_chunk = parseInt(document.getElementById('maxTokensPerChunk').value);
                chunkingConfig.max_overlap_tokens = parseInt(document.getElementById('maxOverlapTokens').value);
            }

            // Show loading state
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Subiendo...';

            uploadStatus.innerHTML = `
                <div style="padding: 12px; background: #FEF3C7; border-radius: 8px; margin-top: 12px; border-left: 4px solid #F59E0B;">
                    <p style="margin: 0; color: #92400E; font-size: 14px;">
                        ‚è≥ Subiendo y procesando archivo... Esto puede tomar hasta 2 minutos.
                    </p>
                </div>
            `;

            // Upload file
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('metadata', JSON.stringify(metadata));
            formData.append('chunking_config', JSON.stringify(chunkingConfig));

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    fileUploaded = true;
                    chatInput.disabled = false;
                    sendBtn.disabled = false;

                    // Clear API docs cache
                    apiInfoCache = null;

                    uploadStatus.innerHTML = `
                        <div style="padding: 12px; background: #D1FAE5; border-radius: 8px; margin-top: 12px; border-left: 4px solid #10B981;">
                            <p style="margin: 0; color: #065F46; font-size: 14px;">
                                ‚úÖ <strong>Archivo subido exitosamente!</strong>
                            </p>
                            <p style="margin: 8px 0 0 0; color: #047857; font-size: 13px;">
                                ${Object.keys(metadata).length} metadatos agregados
                            </p>
                        </div>
                    `;

                    // Reset form
                    selectedFile = null;
                    document.getElementById('metadataSection').style.display = 'none';
                    document.getElementById('metadataFields').innerHTML = '';
                    metadataFieldsCount = 0;
                    document.getElementById('fileInput').value = '';

                    // Reload page state
                    await loadInitialState();
                } else {
                    uploadStatus.innerHTML = `
                        <div style="padding: 12px; background: #FEE2E2; border-radius: 8px; margin-top: 12px; border-left: 4px solid #EF4444;">
                            <p style="margin: 0; color: #991B1B; font-size: 14px;">
                                ‚ùå Error: ${data.error}
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                uploadStatus.innerHTML = `
                    <div style="padding: 12px; background: #FEE2E2; border-radius: 8px; margin-top: 12px; border-left: 4px solid #EF4444;">
                        <p style="margin: 0; color: #991B1B; font-size: 14px;">
                            ‚ùå Error: ${error.message}
                        </p>
                    </div>
                `;
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üì§ Subir Documento';
            }
        }

        // Event listeners for metadata
        document.getElementById('toggleMetadata').addEventListener('click', addMetadataField);
        document.getElementById('uploadWithMetadata').addEventListener('click', uploadFileWithMetadata);
        document.getElementById('enableChunking').addEventListener('change', (e) => {
            document.getElementById('chunkingConfig').style.display = e.target.checked ? 'block' : 'none';
        });

        // Metadata Templates
        const metadataTemplates = {
            factura: [
                { key: 'titulo', value: '', type: 'string' },
                { key: 'tipo', value: 'factura', type: 'string' },
                { key: 'numero_factura', value: '', type: 'string' },
                { key: 'proveedor', value: '', type: 'string' },
                { key: 'cliente', value: '', type: 'string' },
                { key: 'importe', value: '', type: 'number' },
                { key: 'fecha', value: '', type: 'string' },
                { key: 'estado', value: 'pendiente', type: 'string' }
            ],
            contrato: [
                { key: 'titulo', value: '', type: 'string' },
                { key: 'tipo', value: 'contrato', type: 'string' },
                { key: 'partes', value: '', type: 'string' },
                { key: 'fecha_firma', value: '', type: 'string' },
                { key: 'vigencia_hasta', value: '', type: 'string' },
                { key: 'valor_contrato', value: '', type: 'number' },
                { key: 'area', value: '', type: 'string' },
                { key: 'estado', value: 'activo', type: 'string' }
            ],
            informe: [
                { key: 'titulo', value: '', type: 'string' },
                { key: 'tipo', value: 'informe', type: 'string' },
                { key: 'autor', value: '', type: 'string' },
                { key: 'departamento', value: '', type: 'string' },
                { key: 'fecha', value: '', type: 'string' },
                { key: 'periodo', value: '', type: 'string' },
                { key: 'confidencial', value: 'no', type: 'string' }
            ],
            manual: [
                { key: 'titulo', value: '', type: 'string' },
                { key: 'tipo', value: 'manual', type: 'string' },
                { key: 'producto', value: '', type: 'string' },
                { key: 'version', value: '', type: 'string' },
                { key: 'idioma', value: 'espa√±ol', type: 'string' },
                { key: 'autor', value: '', type: 'string' },
                { key: 'fecha_publicacion', value: '', type: 'string' }
            ],
            presentacion: [
                { key: 'titulo', value: '', type: 'string' },
                { key: 'tipo', value: 'presentacion', type: 'string' },
                { key: 'evento', value: '', type: 'string' },
                { key: 'ponente', value: '', type: 'string' },
                { key: 'fecha', value: '', type: 'string' },
                { key: 'audiencia', value: '', type: 'string' },
                { key: 'duracion_min', value: '', type: 'number' }
            ],
            acta: [
                { key: 'titulo', value: '', type: 'string' },
                { key: 'tipo', value: 'acta', type: 'string' },
                { key: 'reunion', value: '', type: 'string' },
                { key: 'fecha', value: '', type: 'string' },
                { key: 'asistentes', value: '', type: 'string' },
                { key: 'secretario', value: '', type: 'string' },
                { key: 'temas_tratados', value: '', type: 'string' }
            ],
            certificado: [
                { key: 'titulo', value: '', type: 'string' },
                { key: 'tipo', value: 'certificado', type: 'string' },
                { key: 'nombre_beneficiario', value: '', type: 'string' },
                { key: 'curso_evento', value: '', type: 'string' },
                { key: 'fecha_emision', value: '', type: 'string' },
                { key: 'institucion', value: '', type: 'string' },
                { key: 'valido_hasta', value: '', type: 'string' }
            ],
            email: [
                { key: 'titulo', value: '', type: 'string' },
                { key: 'tipo', value: 'email', type: 'string' },
                { key: 'remitente', value: '', type: 'string' },
                { key: 'destinatarios', value: '', type: 'string' },
                { key: 'asunto', value: '', type: 'string' },
                { key: 'fecha', value: '', type: 'string' },
                { key: 'prioridad', value: 'normal', type: 'string' }
            ]
        };

        // Handle template selection
        document.getElementById('metadataTemplate').addEventListener('change', (e) => {
            const templateName = e.target.value;
            if (!templateName) return;

            // Clear existing fields
            document.getElementById('metadataFields').innerHTML = '';
            metadataFieldsCount = 0;

            // Apply template
            const template = metadataTemplates[templateName];
            if (template) {
                template.forEach(field => {
                    addMetadataFieldWithValue(field.key, field.value, field.type);
                });

                showNotification(`‚úÖ Plantilla "${e.target.options[e.target.selectedIndex].text}" aplicada`, 'success');
            }
        });

        // Add metadata field with pre-filled values
        function addMetadataFieldWithValue(key = '', value = '', type = 'string') {
            if (metadataFieldsCount >= 20) {
                alert('‚ö†Ô∏è M√°ximo 20 campos de metadatos permitidos');
                return;
            }

            const metadataFields = document.getElementById('metadataFields');
            const fieldId = `metadata-${metadataFieldsCount++}`;

            const fieldHTML = `
                <div class="metadata-field" id="${fieldId}" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: start;">
                    <input type="text" value="${key}" placeholder="Clave (ej: autor, categor√≠a)" class="metadata-key"
                        style="flex: 1; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                    <input type="text" value="${value}" placeholder="Valor" class="metadata-value"
                        style="flex: 1; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                    <select class="metadata-type" style="padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                        <option value="string" ${type === 'string' ? 'selected' : ''}>Texto</option>
                        <option value="number" ${type === 'number' ? 'selected' : ''}>N√∫mero</option>
                    </select>
                    <button onclick="removeMetadataField('${fieldId}')" class="btn-secondary" style="padding: 8px 12px; font-size: 12px;">
                        ‚ùå
                    </button>
                </div>
            `;

            metadataFields.insertAdjacentHTML('beforeend', fieldHTML);
        }

        // Metadata filters management
        let metadataFilters = [];

        // Show/hide filters section
        document.getElementById('showFiltersBtn').addEventListener('click', () => {
            const filtersSection = document.getElementById('metadataFiltersSection');
            filtersSection.style.display = filtersSection.style.display === 'none' ? 'block' : 'none';
        });

        // Add new filter
        document.getElementById('toggleFiltersBtn').addEventListener('click', () => {
            const filterKey = prompt('¬øQu√© metadato quieres filtrar?\n\nEjemplo: tipo, autor, departamento');
            if (!filterKey) return;

            const filterValue = prompt(`¬øQu√© valor debe tener "${filterKey}"?\n\nEjemplo: factura, contrato, informe`);
            if (!filterValue) return;

            addFilter(filterKey, filterValue);
        });

        // Add filter to active filters
        function addFilter(key, value) {
            // Check if filter already exists
            const exists = metadataFilters.some(f => f.key === key && f.value === value);
            if (exists) {
                showNotification('‚ö†Ô∏è Este filtro ya est√° activo', 'info');
                return;
            }

            metadataFilters.push({ key, value });
            renderActiveFilters();
            showNotification(`‚úÖ Filtro agregado: ${key} = ${value}`, 'success');
        }

        // Remove filter
        function removeFilter(index) {
            metadataFilters.splice(index, 1);
            renderActiveFilters();
            showNotification('üóëÔ∏è Filtro eliminado', 'info');
        }

        // Render active filters
        function renderActiveFilters() {
            const activeFiltersContainer = document.getElementById('activeFilters');

            if (metadataFilters.length === 0) {
                activeFiltersContainer.innerHTML = `
                    <span style="font-size: 12px; color: #9CA3AF; font-style: italic;">
                        No hay filtros activos. Haz clic en "Agregar filtro" para filtrar resultados.
                    </span>
                `;
                return;
            }

            const filtersHTML = metadataFilters.map((filter, index) => `
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #DBEAFE; border: 1px solid #93C5FD; border-radius: 6px; font-size: 12px; color: #1E40AF;">
                    <strong>${filter.key}:</strong> ${filter.value}
                    <button onclick="removeFilter(${index})" style="background: none; border: none; color: #1E40AF; cursor: pointer; padding: 0; margin-left: 4px; font-size: 14px; font-weight: bold;">
                        √ó
                    </button>
                </div>
            `).join('');

            activeFiltersContainer.innerHTML = filtersHTML;
        }

        // Initialize filters display
        renderActiveFilters();

        // Send message with loading indicator
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || !fileUploaded) return;

            addMessage('user', message);
            chatInput.value = '';
            sendBtn.disabled = true;
            chatInput.disabled = true;

            // Show loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant loading';
            loadingDiv.id = 'loading-message';
            loadingDiv.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        metadata_filters: metadataFilters
                    })
                });

                const data = await response.json();

                // Remove loading indicator
                const loading = document.getElementById('loading-message');
                if (loading) loading.remove();

                if (response.ok) {
                    // Combinar metadata con informaci√≥n de filtros
                    const fullMetadata = {
                        ...data.metadata,
                        filters_applied: data.metadata_filters_applied,
                        filters_count: data.filters_count
                    };
                    addMessage('assistant', data.response, fullMetadata);
                } else {
                    addMessage('assistant', `Error: ${data.error}`);
                }
            } catch (error) {
                const loading = document.getElementById('loading-message');
                if (loading) loading.remove();
                addMessage('assistant', `Error: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                chatInput.disabled = false;
                chatInput.focus();
            }
        }

        // Add message with markdown support
        function addMessage(role, content, metadata = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            // Convert markdown to HTML for assistant messages
            const formattedContent = role === 'assistant' && typeof marked !== 'undefined'
                ? marked.parse(content)
                : content;

            // Build filters info if available
            let filtersInfo = '';
            if (metadata && metadata.filters_count > 0 && metadata.filters_applied) {
                const filterBadges = metadata.filters_applied.map(filter =>
                    `<span style="background: #DBEAFE; color: #1E40AF; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 4px;">
                        ${filter.key} = ${filter.value}
                    </span>`
                ).join('');

                filtersInfo = `
                    <div style="margin-top: 12px; padding: 8px 12px; background: #EFF6FF; border-left: 3px solid #3B82F6; border-radius: 4px;">
                        <div style="font-size: 12px; color: #1E40AF; font-weight: 600; margin-bottom: 4px;">
                            üîç Filtros aplicados (${metadata.filters_count}):
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                            ${filterBadges}
                        </div>
                    </div>
                `;
            }

            messageDiv.innerHTML = `
                <div class="message-content">
                    ${formattedContent}
                    ${filtersInfo}
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Tab switching function
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const selectedTab = document.getElementById(`${tabName}-tab`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            event.target.classList.add('active');

            // Load data based on selected tab
            if (tabName === 'settings') {
                loadSettings();
            } else if (tabName === 'docs' && !apiInfoCache) {
                loadApiDocumentation();
            } else if (tabName === 'stores') {
                loadStoresTab();
            }
        };

        // Load Settings
        async function loadSettings() {
            try {
                const response = await fetch('/api-info');
                const data = await response.json();

                // Update current API key display
                const currentKeyEl = document.getElementById('currentApiKey');
                if (currentKeyEl && data.api_key) {
                    const maskedKey = data.api_key.substring(0, 10) + '...' + data.api_key.substring(data.api_key.length - 4);
                    currentKeyEl.textContent = maskedKey;
                }

                // Load metadata model preference
                const metadataModel = localStorage.getItem('metadata_model') || 'gemini-2.5-flash';
                const selector = document.getElementById('metadataModelSelector');
                if (selector) {
                    selector.value = metadataModel;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save metadata model preference
        window.saveMetadataModelPreference = function() {
            const selector = document.getElementById('metadataModelSelector');
            const selectedModel = selector.value;

            localStorage.setItem('metadata_model', selectedModel);

            showNotification(`‚úÖ Modelo "${selectedModel}" guardado para generaci√≥n de metadatos`, 'success');
        }

        // Load API documentation
        async function loadApiDocumentation() {
            const container = document.getElementById('apiDocsContainer');

            try {
                const response = await fetch('/api-info');
                const data = await response.json();
                apiInfoCache = data;

                if (!data.store_exists) {
                    container.innerHTML = `
                        <div class="no-store-message">
                            <h3>üì¶ No File Search Store Yet</h3>
                            <p>Upload a document in the Upload tab first.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = await generateApiDocumentation(data);
                initializeHttpGenerator();

            } catch (error) {
                console.error('Error loading API info:', error);
                container.innerHTML = `
                    <div class="no-store-message">
                        <h3>‚ö†Ô∏è Error Loading API Information</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Generate API documentation HTML - NUEVO GENERADOR COMPLETO
        async function generateApiDocumentation(data) {
            // Fetch stores for selector
            let storesOptions = '<option value="">Cargando stores...</option>';
            try {
                const storesResponse = await fetch('/stores');
                const storesData = await storesResponse.json();
                if (storesData.stores && storesData.stores.length > 0) {
                    storesOptions = storesData.stores.map(store =>
                        `<option value="${store.name}" ${store.name === data.store_name ? 'selected' : ''}>
                            ${store.display_name || store.name.split('/')[1]} (${store.active_documents_count || 0} docs)
                        </option>`
                    ).join('');
                } else {
                    storesOptions = '<option value="">No hay stores disponibles</option>';
                }
            } catch (error) {
                storesOptions = '<option value="">Error al cargar stores</option>';
            }

            // Store API key and base data globally for generators
            window.apiData = {
                apiKey: data.api_key,
                currentStore: data.store_name,
                storesOptions: storesOptions
            };

            return `
                <div style="max-width: 1400px; margin: 0 auto;">

                    <!-- Header con gradiente azul Webcomunica -->
                    <div style="margin-bottom: 40px; padding: 32px; background: linear-gradient(135deg, #005a8a 0%, #0081BA 100%); border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 129, 186, 0.2);">
                        <h1 style="font-size: 32px; margin-bottom: 12px; color: white; font-weight: 700;">üîß ${t('docs.generator.title') || 'HTTP Request Generator'}</h1>
                        <p style="color: #d4f1ff; font-size: 18px; margin: 0;">${t('docs.generator.subtitle') || 'Genera peticiones HTTP completas para todas las operaciones de Gemini File Search API'}</p>
                    </div>

                    <!-- Selector de Operaci√≥n -->
                    <div class="card" style="margin-bottom: 28px; padding: 28px; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 129, 186, 0.1);">
                        <h2 style="font-size: 22px; margin-bottom: 20px; color: #0081BA; font-weight: 700;">1Ô∏è‚É£ ${t('docs.generator.selectOperation')}</h2>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px;">
                            <button class="operation-btn active" data-operation="create-store" style="padding: 20px; background: linear-gradient(135deg, #d4f1ff 0%, #e6f7ff 100%); border: 2px solid #0081BA; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0, 129, 186, 0.15);">
                                <div style="font-size: 28px; margin-bottom: 8px;">üì¶</div>
                                <div style="font-weight: 700; color: #005a8a; font-size: 16px;">${t('docs.operations.createStore')}</div>
                                <div style="font-size: 13px; color: #0081BA;">${t('docs.operations.createStoreDesc')}</div>
                            </button>

                            <button class="operation-btn" data-operation="list-stores" style="padding: 20px; background: #F8FAFC; border: 2px solid #E2E8F0; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.3s;">
                                <div style="font-size: 28px; margin-bottom: 8px;">üìã</div>
                                <div style="font-weight: 700; color: #334155; font-size: 16px;">${t('docs.operations.listStores')}</div>
                                <div style="font-size: 13px; color: #64748B;">${t('docs.operations.listStoresDesc')}</div>
                            </button>

                            <button class="operation-btn" data-operation="upload-document" style="padding: 20px; background: #F8FAFC; border: 2px solid #E2E8F0; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.3s;">
                                <div style="font-size: 28px; margin-bottom: 8px;">üì§</div>
                                <div style="font-weight: 700; color: #334155; font-size: 16px;">${t('docs.operations.uploadDocument')}</div>
                                <div style="font-size: 13px; color: #64748B;">${t('docs.operations.uploadDocumentDesc')}</div>
                            </button>

                            <button class="operation-btn" data-operation="chat-rag" style="padding: 20px; background: #F8FAFC; border: 2px solid #E2E8F0; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.3s;">
                                <div style="font-size: 28px; margin-bottom: 8px;">üí¨</div>
                                <div style="font-weight: 700; color: #334155; font-size: 16px;">${t('docs.operations.chatRag')}</div>
                                <div style="font-size: 13px; color: #64748B;">${t('docs.operations.chatRagDesc')}</div>
                            </button>

                            <button class="operation-btn" data-operation="list-documents" style="padding: 20px; background: #F8FAFC; border: 2px solid #E2E8F0; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.3s;">
                                <div style="font-size: 28px; margin-bottom: 8px;">üìÑ</div>
                                <div style="font-weight: 700; color: #334155; font-size: 16px;">${t('docs.operations.listDocuments')}</div>
                                <div style="font-size: 13px; color: #64748B;">${t('docs.operations.listDocumentsDesc')}</div>
                            </button>

                            <button class="operation-btn" data-operation="delete-document" style="padding: 20px; background: #F8FAFC; border: 2px solid #E2E8F0; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.3s;">
                                <div style="font-size: 28px; margin-bottom: 8px;">üóëÔ∏è</div>
                                <div style="font-weight: 700; color: #334155; font-size: 16px;">${t('docs.operations.deleteDocument')}</div>
                                <div style="font-size: 13px; color: #64748B;">${t('docs.operations.deleteDocumentDesc')}</div>
                            </button>

                            <button class="operation-btn" data-operation="delete-store" style="padding: 20px; background: #F8FAFC; border: 2px solid #E2E8F0; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.3s;">
                                <div style="font-size: 28px; margin-bottom: 8px;">üóëÔ∏è</div>
                                <div style="font-weight: 700; color: #334155; font-size: 16px;">${t('docs.operations.deleteStore')}</div>
                                <div style="font-size: 13px; color: #64748B;">${t('docs.operations.deleteStoreDesc')}</div>
                            </button>

                            <button class="operation-btn" data-operation="get-operation" style="padding: 20px; background: #F8FAFC; border: 2px solid #E2E8F0; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.3s;">
                                <div style="font-size: 28px; margin-bottom: 8px;">‚è≥</div>
                                <div style="font-weight: 700; color: #334155; font-size: 16px;">${t('docs.operations.getOperation')}</div>
                                <div style="font-size: 13px; color: #64748B;">${t('docs.operations.getOperationDesc')}</div>
                            </button>
                        </div>
                    </div>

                    <!-- Formulario de Configuraci√≥n -->
                    <div class="card" id="configForm" style="margin-bottom: 28px; padding: 28px; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 129, 186, 0.1);">
                        <h2 style="font-size: 22px; margin-bottom: 20px; color: #0081BA; font-weight: 700;">2Ô∏è‚É£ ${t('docs.generator.configureParams')}</h2>
                        <div id="dynamicParams"></div>
                    </div>

                    <!-- Selector de Formato -->
                    <div class="card" id="formatSelector" style="margin-bottom: 28px; padding: 28px; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 129, 186, 0.1);">
                        <h2 style="font-size: 22px; margin-bottom: 20px; color: #0081BA; font-weight: 700;">3Ô∏è‚É£ ${t('docs.generator.chooseFormat')}</h2>

                        <div style="display: flex; gap: 14px; flex-wrap: wrap;">
                            <button class="format-btn active" data-format="curl" style="padding: 14px 28px; background: linear-gradient(135deg, #0081BA 0%, #005a8a 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0, 129, 186, 0.3); font-size: 15px;">
                                üìã cURL
                            </button>
                            <button class="format-btn" data-format="python" style="padding: 14px 28px; background: white; color: #334155; border: 2px solid #CBD5E1; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.3s; font-size: 15px;">
                                üêç Python
                            </button>
                            <button class="format-btn" data-format="javascript" style="padding: 14px 28px; background: white; color: #334155; border: 2px solid #CBD5E1; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.3s; font-size: 15px;">
                                üìú JavaScript
                            </button>
                            <button class="format-btn" data-format="n8n" style="padding: 14px 28px; background: white; color: #334155; border: 2px solid #CBD5E1; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.3s; font-size: 15px;">
                                üîß n8n
                            </button>
                            <button class="format-btn" data-format="make" style="padding: 14px 28px; background: white; color: #334155; border: 2px solid #CBD5E1; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.3s; font-size: 15px;">
                                üéØ Make.com
                            </button>
                            <button class="format-btn" data-format="postman" style="padding: 14px 28px; background: white; color: #334155; border: 2px solid #CBD5E1; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.3s; font-size: 15px;">
                                üìÆ Postman
                            </button>
                        </div>
                    </div>

                    <!-- C√≥digo Generado -->
                    <div class="card" id="generatedCode" style="padding: 28px; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 129, 186, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="font-size: 22px; margin: 0; color: #0081BA; font-weight: 700;">4Ô∏è‚É£ ${t('docs.generator.copyCode')}</h2>
                            <button id="copyGeneratedBtn" class="btn btn-primary" style="padding: 12px 24px; background: linear-gradient(135deg, #0081BA 0%, #005a8a 100%); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0, 129, 186, 0.3);">
                                ${t('docs.generator.copyCodeBtn')}
                            </button>
                        </div>

                        <div style="background: #0F172A; color: #E2E8F0; padding: 24px; border-radius: 12px; overflow-x: auto; border: 2px solid #0081BA;">
                            <pre id="codeOutput" style="margin: 0; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.8; white-space: pre-wrap;"></pre>
                        </div>

                        <!-- Explicaci√≥n -->
                        <div id="codeExplanation" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #e6f7ff 0%, #d4f1ff 100%); border-left: 4px solid #0081BA; border-radius: 12px;">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>

                    <!-- Gu√≠a R√°pida -->
                    <div class="card" style="margin-top: 32px; padding: 28px; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 129, 186, 0.1);">
                        <h2 style="font-size: 22px; margin-bottom: 20px; color: #0081BA; font-weight: 700;">${t('docs.generator.quickGuide')}</h2>

                        <div style="display: grid; gap: 18px;">
                            <div style="padding: 20px; background: linear-gradient(135deg, #d4f1ff 0%, #e6f7ff 100%); border-left: 4px solid #0081BA; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 129, 186, 0.1);">
                                <strong style="display: block; color: #005a8a; margin-bottom: 10px; font-size: 16px;">${t('docs.generator.yourApiKey')}</strong>
                                <p style="margin: 0; color: #005a8a; font-size: 14px;">${t('docs.generator.apiKeyLabel')} <code style="background: white; padding: 4px 10px; border-radius: 6px; color: #0081BA; font-weight: 600;">${data.api_key.substring(0, 20)}...</code></p>
                            </div>

                            <div style="padding: 20px; background: linear-gradient(135deg, #d4f1ff 0%, #e6f7ff 100%); border-left: 4px solid #0081BA; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 129, 186, 0.1);">
                                <strong style="display: block; color: #005a8a; margin-bottom: 10px; font-size: 16px;">${t('docs.generator.baseEndpoint')}</strong>
                                <p style="margin: 0; color: #005a8a; font-size: 14px;">
                                    <code style="background: white; padding: 4px 10px; border-radius: 6px; color: #0081BA; font-weight: 600;">https://generativelanguage.googleapis.com/v1beta</code>
                                </p>
                            </div>

                            <div style="padding: 20px; background: linear-gradient(135deg, #d4f1ff 0%, #e6f7ff 100%); border-left: 4px solid #0081BA; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 129, 186, 0.1);">
                                <strong style="display: block; color: #005a8a; margin-bottom: 10px; font-size: 16px;">${t('docs.generator.documentation')}</strong>
                                <p style="margin: 0; color: #005a8a; font-size: 14px;">
                                    <a href="https://ai.google.dev/gemini-api/docs/file-search" target="_blank" style="color: #0081BA; text-decoration: none; font-weight: 600; border-bottom: 2px solid #0081BA;">Gemini File Search API Docs ‚Üí</a>
                                </p>
                            </div>
                        </div>
                    </div>

                </div>
            `;
        }


        // ==========================================
        // NUEVO GENERADOR HTTP - FUNCIONES DE SOPORTE
        // ==========================================

        // Global variables for HTTP generator
        let currentOperation = 'create-store';
        let currentFormat = 'curl';

        // Initialize HTTP Request Generator after loading docs
        window.initializeHttpGenerator = function() {
            // Operation buttons
            document.querySelectorAll('.operation-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Update active state - colores Webcomunica #0081BA
                    document.querySelectorAll('.operation-btn').forEach(b => {
                        b.style.background = '#F8FAFC';
                        b.style.borderColor = '#E2E8F0';
                        b.style.boxShadow = 'none';
                        // Reset text colors
                        b.querySelector('div:nth-child(2)').style.color = '#334155';
                        b.querySelector('div:nth-child(3)').style.color = '#64748B';
                    });
                    this.style.background = 'linear-gradient(135deg, #d4f1ff 0%, #e6f7ff 100%)';
                    this.style.borderColor = '#0081BA';
                    this.style.boxShadow = '0 4px 12px rgba(0, 129, 186, 0.15)';
                    // Update text colors for active button
                    this.querySelector('div:nth-child(2)').style.color = '#005a8a';
                    this.querySelector('div:nth-child(3)').style.color = '#0081BA';

                    // Get operation
                    currentOperation = this.getAttribute('data-operation');

                    // Generate params form
                    generateParamsForm(currentOperation);

                    // Generate code
                    generateCode();
                });
            });

            // Format buttons
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Update active state - gradiente Webcomunica
                    document.querySelectorAll('.format-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#334155';
                        b.style.border = '2px solid #CBD5E1';
                        b.style.boxShadow = 'none';
                    });
                    this.style.background = 'linear-gradient(135deg, #0081BA 0%, #005a8a 100%)';
                    this.style.color = 'white';
                    this.style.border = 'none';
                    this.style.boxShadow = '0 4px 12px rgba(0, 129, 186, 0.3)';

                    // Get format
                    currentFormat = this.getAttribute('data-format');

                    // Regenerate code
                    generateCode();
                });
            });

            // Copy button
            document.getElementById('copyGeneratedBtn')?.addEventListener('click', function() {
                const code = document.getElementById('codeOutput').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    const originalText = this.innerHTML;
                    this.innerHTML = t('docs.generator.copied');
                    setTimeout(() => {
                        this.innerHTML = originalText;
                    }, 2000);
                });
            });

            // Generate initial form and code
            generateParamsForm(currentOperation);
            generateCode();
        };

        // Generate params form based on operation
        function generateParamsForm(operation) {
            const container = document.getElementById('dynamicParams');
            if (!container) return;

            let formHTML = '';

            switch(operation) {
                case 'create-store':
                    formHTML = `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #374151;">
                                ${t('docs.params.storeName')}
                            </label>
                            <input type="text" id="param-store-name" value="my-documents-store" onkeyup="generateCode()"
                                   style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #6B7280;">${t('docs.params.storeNameHelp')}</p>
                        </div>
                    `;
                    break;

                case 'list-stores':
                    formHTML = `
                        <div style="padding: 16px; background: #EFF6FF; border-radius: 8px;">
                            <p style="margin: 0; color: #1E40AF; font-size: 14px;">${t('docs.params.noParams')}</p>
                        </div>
                    `;
                    break;

                case 'upload-document':
                    formHTML = `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #374151;">
                                ${t('docs.params.targetStore')}
                            </label>
                            <select id="param-upload-store" onchange="generateCode()"
                                    style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                                ${window.apiData.storesOptions}
                            </select>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #374151;">
                                ${t('docs.params.fileName')}
                            </label>
                            <input type="text" id="param-file-name" value="documento.pdf" onkeyup="generateCode()"
                                   style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #374151;">
                                ${t('docs.params.mimeType')}
                            </label>
                            <select id="param-mime-type" onchange="generateCode()"
                                    style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                                <option value="application/pdf">PDF (application/pdf)</option>
                                <option value="application/vnd.openxmlformats-officedocument.wordprocessingml.document">DOCX</option>
                                <option value="text/plain">TXT (text/plain)</option>
                                <option value="text/markdown">Markdown (text/markdown)</option>
                            </select>
                        </div>
                    `;
                    break;

                case 'chat-rag':
                    formHTML = `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #374151;">
                                ${t('docs.params.storeToQuery')}
                            </label>
                            <select id="param-chat-store" onchange="generateCode()"
                                    style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                                ${window.apiData.storesOptions}
                            </select>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #374151;">
                                ${t('docs.params.yourQuestion')}
                            </label>
                            <textarea id="param-query" onkeyup="generateCode()"
                                      style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px; min-height: 100px; font-family: inherit;">${t('docs.params.questionPlaceholder')}</textarea>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #374151;">
                                ${t('docs.params.model')}
                            </label>
                            <select id="param-model" onchange="generateCode()"
                                    style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                                <option value="gemini-2.5-flash" selected>gemini-2.5-flash</option>
                                <option value="gemini-2.5-pro">gemini-2.5-pro</option>
                                <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                                <option value="gemini-1.5-pro">gemini-1.5-pro</option>
                            </select>
                        </div>
                    `;
                    break;

                case 'list-documents':
                    formHTML = `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #374151;">
                                ${t('docs.params.store')}
                            </label>
                            <select id="param-list-store" onchange="generateCode()"
                                    style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                                ${window.apiData.storesOptions}
                            </select>
                        </div>
                    `;
                    break;

                case 'delete-document':
                    formHTML = `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #374151;">
                                ${t('docs.params.store')}
                            </label>
                            <select id="param-delete-doc-store" onchange="generateCode()"
                                    style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                                ${window.apiData.storesOptions}
                            </select>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #374151;">
                                ${t('docs.params.documentId')}
                            </label>
                            <input type="text" id="param-doc-id" value="document-id-here" onkeyup="generateCode()"
                                   style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #6B7280;">${t('docs.params.documentIdHelp')}</p>
                        </div>
                    `;
                    break;

                case 'delete-store':
                    formHTML = `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #374151;">
                                ${t('docs.params.storeToDelete')}
                            </label>
                            <select id="param-delete-store" onchange="generateCode()"
                                    style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                                ${window.apiData.storesOptions}
                            </select>
                        </div>
                        <div style="padding: 16px; background: #FEF2F2; border-left: 4px solid #EF4444; border-radius: 8px;">
                            <p style="margin: 0; color: #991B1B; font-size: 14px;">${t('docs.params.deleteWarning')}</p>
                        </div>
                    `;
                    break;

                case 'get-operation':
                    formHTML = `
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #374151;">
                                ${t('docs.params.operationId')}
                            </label>
                            <input type="text" id="param-operation-id" value="operation-id-here" onkeyup="generateCode()"
                                   style="width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #6B7280;">${t('docs.params.operationIdHelp')}</p>
                        </div>
                    `;
                    break;
            }

            container.innerHTML = formHTML;
        }

        // Generate code based on operation and format
        function generateCode() {
            const output = document.getElementById('codeOutput');
            const explanation = document.getElementById('codeExplanation');
            if (!output) return;

            let code = '';
            let explainText = '';

            // Get params
            const params = getParams();

            // Generate code based on format
            switch(currentFormat) {
                case 'curl':
                    ({ code, explainText } = generateCurl(currentOperation, params));
                    break;
                case 'python':
                    ({ code, explainText } = generatePython(currentOperation, params));
                    break;
                case 'javascript':
                    ({ code, explainText } = generateJavaScript(currentOperation, params));
                    break;
                case 'n8n':
                    ({ code, explainText } = generateN8N(currentOperation, params));
                    break;
                case 'make':
                    ({ code, explainText } = generateMake(currentOperation, params));
                    break;
                case 'postman':
                    ({ code, explainText } = generatePostman(currentOperation, params));
                    break;
            }

            output.textContent = code;
            if (explanation) {
                explanation.innerHTML = `<strong style="color: #1E40AF;">${t('docs.explain.title')}</strong><p style="margin: 8px 0 0 0; color: #1E3A8A;">${explainText}</p>`;
            }
        }

        // Get current params from form
        function getParams() {
            return {
                apiKey: window.apiData.apiKey,
                storeName: document.getElementById('param-store-name')?.value || '',
                uploadStore: document.getElementById('param-upload-store')?.value || '',
                fileName: document.getElementById('param-file-name')?.value || 'document.pdf',
                mimeType: document.getElementById('param-mime-type')?.value || 'application/pdf',
                chatStore: document.getElementById('param-chat-store')?.value || '',
                query: document.getElementById('param-query')?.value || '',
                model: document.getElementById('param-model')?.value || 'gemini-2.5-flash',
                listStore: document.getElementById('param-list-store')?.value || '',
                deleteDocStore: document.getElementById('param-delete-doc-store')?.value || '',
                docId: document.getElementById('param-doc-id')?.value || '',
                deleteStore: document.getElementById('param-delete-store')?.value || '',
                operationId: document.getElementById('param-operation-id')?.value || ''
            };
        }

        // ==========================================
        // CODE GENERATORS BY FORMAT
        // ==========================================

        // Generate cURL code
        function generateCurl(operation, params) {
            let code = '';
            let explainText = '';

            const baseUrl = 'https://generativelanguage.googleapis.com/v1beta';

            switch(operation) {
                case 'create-store':
                    code = `curl -X POST "${baseUrl}/fileSearchStores?key=${params.apiKey}" \\
  -H "Content-Type: application/json" \\
  -d '{
    "displayName": "${params.storeName}"
  }'`;
                    explainText = t('docs.explain.createStore');
                    break;

                case 'list-stores':
                    code = `curl -X GET "${baseUrl}/fileSearchStores?key=${params.apiKey}&pageSize=20"`;
                    explainText = t('docs.explain.listStores');
                    break;

                case 'upload-document':
                    code = `# Paso 1: Obtener upload URL
curl -X POST "${baseUrl}/${params.uploadStore}:uploadToFileSearchStore?key=${params.apiKey}" \\
  -H "X-Goog-Upload-Protocol: resumable" \\
  -H "X-Goog-Upload-Command: start" \\
  -H "X-Goog-Upload-Header-Content-Type: ${params.mimeType}" \\
  -H "Content-Type: application/json" \\
  -d '{
    "file": {
      "displayName": "${params.fileName}"
    }
  }'

# Paso 2: Upload file content (obtener upload_url del paso 1)
curl -X POST "<upload_url>" \\
  -H "Content-Type: ${params.mimeType}" \\
  -H "X-Goog-Upload-Offset: 0" \\
  -H "X-Goog-Upload-Command: upload, finalize" \\
  --data-binary "@${params.fileName}"`;
                    explainText = t('docs.explain.uploadDocument');
                    break;

                case 'chat-rag':
                    code = `curl -X POST "${baseUrl}/models/${params.model}:generateContent?key=${params.apiKey}" \\
  -H "Content-Type: application/json" \\
  -d '{
    "contents": [{
      "parts": [{
        "text": "${params.query}"
      }]
    }],
    "tools": [{
      "fileSearchTool": {
        "fileSearchStores": ["${params.chatStore}"]
      }
    }]
  }'`;
                    explainText = t('docs.explain.chatRag');
                    break;

                case 'list-documents':
                    code = `curl -X GET "${baseUrl}/${params.listStore}/documents?key=${params.apiKey}&pageSize=20"`;
                    explainText = t('docs.explain.listDocuments');
                    break;

                case 'delete-document':
                    code = `curl -X DELETE "${baseUrl}/${params.deleteDocStore}/documents/${params.docId}?key=${params.apiKey}&force=true"`;
                    explainText = t('docs.explain.deleteDocument');
                    break;

                case 'delete-store':
                    code = `curl -X DELETE "${baseUrl}/${params.deleteStore}?key=${params.apiKey}&force=true"`;
                    explainText = t('docs.explain.deleteStore');
                    break;

                case 'get-operation':
                    code = `curl -X GET "${baseUrl}/${params.operationId}?key=${params.apiKey}"`;
                    explainText = t('docs.explain.getOperation');
                    break;
            }

            return { code, explainText };
        }

        // Generate Python code
        function generatePython(operation, params) {
            let code = '';
            let explainText = '';

            switch(operation) {
                case 'create-store':
                    code = `from google import genai

client = genai.Client(api_key='${params.apiKey}')

# Crear nuevo File Search Store
store = client.file_search_stores.create(
    display_name='${params.storeName}'
)

print(f"‚úÖ Store creado: {store.name}")
print(f"   Display name: {store.display_name}")`;
                    explainText = t('docs.explain.createStore');
                    break;

                case 'list-stores':
                    code = `from google import genai

client = genai.Client(api_key='${params.apiKey}')

# Listar todos los stores
stores = client.file_search_stores.list(page_size=20)

for store in stores:
    print(f"üì¶ {store.display_name or store.name}")
    print(f"   Documentos activos: {store.active_documents_count}")
    print(f"   Tama√±o: {store.size_bytes} bytes")
    print()`;
                    explainText = t('docs.explain.listStores');
                    break;

                case 'upload-document':
                    code = `from google import genai
import time

client = genai.Client(api_key='${params.apiKey}')

# Upload y procesamiento de documento
operation = client.file_search_stores.upload_to_file_search_store(
    file_search_store='${params.uploadStore}',
    path='${params.fileName}',
    display_name='${params.fileName}',
    mime_type='${params.mimeType}'
)

print("‚è≥ Procesando documento...")

# Esperar a que termine el procesamiento
while not operation.done:
    time.sleep(5)
    operation = client.operations.get(operation=operation.name)
    print(".", end="", flush=True)

print()
if operation.error:
    print(f"‚ùå Error: {operation.error.message}")
else:
    print(f"‚úÖ Documento subido: {operation.response}")`;
                    explainText = t('docs.explain.uploadDocument');
                    break;

                case 'chat-rag':
                    code = `from google import genai
from google.genai import types

client = genai.Client(api_key='${params.apiKey}')

# Consulta RAG con File Search
response = client.models.generate_content(
    model='${params.model}',
    contents='${params.query}',
    config=types.GenerateContentConfig(
        tools=[types.Tool(
            file_search_tool=types.FileSearchTool(
                file_search_stores=['${params.chatStore}']
            )
        )]
    )
)

# Mostrar respuesta
print("ü§ñ Respuesta:")
print(response.text)

# Mostrar citaciones
if response.candidates[0].grounding_metadata:
    print("\\nüìö Fuentes:")
    for chunk in response.candidates[0].grounding_metadata.file_search_grounding_chunks:
        print(f"  - {chunk.document_display_name} (chunk {chunk.chunk_id})")`;
                    explainText = t('docs.explain.chatRag');
                    break;

                case 'list-documents':
                    code = `from google import genai

client = genai.Client(api_key='${params.apiKey}')

# Listar documentos del store
documents = client.file_search_stores.documents.list(
    file_search_store='${params.listStore}',
    page_size=20
)

for doc in documents:
    status = "‚úÖ" if doc.state == "STATE_ACTIVE" else "‚è≥"
    print(f"{status} {doc.display_name or doc.name}")
    print(f"   Estado: {doc.state}")
    print(f"   Tama√±o: {doc.size_bytes} bytes")
    if doc.custom_metadata:
        print(f"   Metadata: {doc.custom_metadata}")
    print()`;
                    explainText = t('docs.explain.listDocuments');
                    break;

                case 'delete-document':
                    code = `from google import genai

client = genai.Client(api_key='${params.apiKey}')

# Eliminar documento
client.file_search_stores.documents.delete(
    name='${params.deleteDocStore}/documents/${params.docId}',
    force=True
)

print("‚úÖ Documento eliminado")`;
                    explainText = t('docs.explain.deleteDocument');
                    break;

                case 'delete-store':
                    code = `from google import genai

client = genai.Client(api_key='${params.apiKey}')

# ‚ö†Ô∏è CUIDADO: Eliminar store completo
if input("¬øConfirmar eliminaci√≥n del store? (yes/no): ") == "yes":
    client.file_search_stores.delete(
        name='${params.deleteStore}',
        force=True
    )
    print("‚úÖ Store eliminado")
else:
    print("‚ùå Cancelado")`;
                    explainText = t('docs.explain.deleteStore');
                    break;

                case 'get-operation':
                    code = `from google import genai

client = genai.Client(api_key='${params.apiKey}')

# Verificar estado de operaci√≥n
operation = client.operations.get(operation='${params.operationId}')

print(f"Estado: {'Completado ‚úÖ' if operation.done else 'En progreso ‚è≥'}")

if operation.done:
    if operation.error:
        print(f"‚ùå Error: {operation.error.message}")
    else:
        print(f"‚úÖ Resultado: {operation.response}")`;
                    explainText = t('docs.explain.getOperation');
                    break;
            }

            return { code, explainText };
        }

        // Generate JavaScript code
        function generateJavaScript(operation, params) {
            let code = '';
            let explainText = '';

            switch(operation) {
                case 'create-store':
                    code = `const { GoogleGenAI } = require('@google/genai');

const ai = new GoogleGenAI({ apiKey: '${params.apiKey}' });

// Crear nuevo File Search Store
async function createStore() {
  const store = await ai.fileSearchStores.create({
    displayName: '${params.storeName}'
  });

  console.log('‚úÖ Store creado:', store.name);
  console.log('   Display name:', store.displayName);
  return store;
}

createStore();`;
                    explainText = t('docs.explain.createStore');
                    break;

                case 'list-stores':
                    code = `const { GoogleGenAI } = require('@google/genai');

const ai = new GoogleGenAI({ apiKey: '${params.apiKey}' });

// Listar todos los stores
async function listStores() {
  const stores = await ai.fileSearchStores.list({ pageSize: 20 });

  stores.forEach(store => {
    console.log(\`üì¶ \${store.displayName || store.name}\`);
    console.log(\`   Documentos: \${store.activeDocumentsCount}\`);
    console.log(\`   Tama√±o: \${store.sizeBytes} bytes\`);
  });
}

listStores();`;
                    explainText = t('docs.explain.listStores');
                    break;

                case 'upload-document':
                    code = `const { GoogleGenAI } = require('@google/genai');
const fs = require('fs');

const ai = new GoogleGenAI({ apiKey: '${params.apiKey}' });

// Upload documento
async function uploadDocument() {
  const operation = await ai.fileSearchStores.uploadToFileSearchStore({
    fileSearchStore: '${params.uploadStore}',
    file: fs.createReadStream('${params.fileName}'),
    displayName: '${params.fileName}',
    mimeType: '${params.mimeType}'
  });

  console.log('‚è≥ Procesando documento...');

  // Esperar procesamiento
  let op = operation;
  while (!op.done) {
    await new Promise(resolve => setTimeout(resolve, 5000));
    op = await ai.operations.get({ operation: op.name });
    process.stdout.write('.');
  }

  console.log();
  if (op.error) {
    console.log('‚ùå Error:', op.error.message);
  } else {
    console.log('‚úÖ Documento subido:', op.response);
  }
}

uploadDocument();`;
                    explainText = t('docs.explain.uploadDocument');
                    break;

                case 'chat-rag':
                    code = `const { GoogleGenAI } = require('@google/genai');

const ai = new GoogleGenAI({ apiKey: '${params.apiKey}' });

// Consulta RAG
async function chatRAG() {
  const response = await ai.models.generateContent({
    model: '${params.model}',
    contents: [{ parts: [{ text: '${params.query}' }] }],
    config: {
      tools: [{
        fileSearchTool: {
          fileSearchStores: ['${params.chatStore}']
        }
      }]
    }
  });

  console.log('ü§ñ Respuesta:');
  console.log(response.text);

  // Citaciones
  const grounding = response.candidates[0].groundingMetadata;
  if (grounding?.fileSearchGroundingChunks) {
    console.log('\\nüìö Fuentes:');
    grounding.fileSearchGroundingChunks.forEach(chunk => {
      console.log(\`  - \${chunk.documentDisplayName} (chunk \${chunk.chunkId})\`);
    });
  }
}

chatRAG();`;
                    explainText = t('docs.explain.chatRag');
                    break;

                case 'list-documents':
                    code = `const { GoogleGenAI } = require('@google/genai');

const ai = new GoogleGenAI({ apiKey: '${params.apiKey}' });

// Listar documentos
async function listDocuments() {
  const documents = await ai.fileSearchStores.documents.list({
    fileSearchStore: '${params.listStore}',
    pageSize: 20
  });

  documents.forEach(doc => {
    const status = doc.state === 'STATE_ACTIVE' ? '‚úÖ' : '‚è≥';
    console.log(\`\${status} \${doc.displayName || doc.name}\`);
    console.log(\`   Estado: \${doc.state}\`);
    console.log(\`   Tama√±o: \${doc.sizeBytes} bytes\`);
    if (doc.customMetadata) {
      console.log(\`   Metadata:\`, doc.customMetadata);
    }
  });
}

listDocuments();`;
                    explainText = t('docs.explain.listDocuments');
                    break;

                case 'delete-document':
                    code = `const { GoogleGenAI } = require('@google/genai');

const ai = new GoogleGenAI({ apiKey: '${params.apiKey}' });

// Eliminar documento
async function deleteDocument() {
  await ai.fileSearchStores.documents.delete({
    name: '${params.deleteDocStore}/documents/${params.docId}',
    force: true
  });

  console.log('‚úÖ Documento eliminado');
}

deleteDocument();`;
                    explainText = t('docs.explain.deleteDocument');
                    break;

                case 'delete-store':
                    code = `const { GoogleGenAI } = require('@google/genai');
const readline = require('readline');

const ai = new GoogleGenAI({ apiKey: '${params.apiKey}' });

// ‚ö†Ô∏è Eliminar store
async function deleteStore() {
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });

  rl.question('‚ö†Ô∏è ¬øEliminar store completo? (yes/no): ', async (answer) => {
    if (answer === 'yes') {
      await ai.fileSearchStores.delete({
        name: '${params.deleteStore}',
        force: true
      });
      console.log('‚úÖ Store eliminado');
    } else {
      console.log('‚ùå Cancelado');
    }
    rl.close();
  });
}

deleteStore();`;
                    explainText = t('docs.explain.deleteStore');
                    break;

                case 'get-operation':
                    code = `const { GoogleGenAI } = require('@google/genai');

const ai = new GoogleGenAI({ apiKey: '${params.apiKey}' });

// Verificar operaci√≥n
async function checkOperation() {
  const operation = await ai.operations.get({
    operation: '${params.operationId}'
  });

  console.log(\`Estado: \${operation.done ? 'Completado ‚úÖ' : 'En progreso ‚è≥'}\`);

  if (operation.done) {
    if (operation.error) {
      console.log('‚ùå Error:', operation.error.message);
    } else {
      console.log('‚úÖ Resultado:', operation.response);
    }
  }
}

checkOperation();`;
                    explainText = t('docs.explain.getOperation');
                    break;
            }

            return { code, explainText };
        }

        // Generate n8n workflow JSON
        function generateN8N(operation, params) {
            let code = '';
            let explainText = '';

            switch(operation) {
                case 'create-store':
                    code = `{
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/fileSearchStores",
        "authentication": "genericCredentialType",
        "genericAuthType": "queryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "${params.apiKey}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "displayName",
              "value": "${params.storeName}"
            }
          ]
        },
        "options": {}
      },
      "name": "Create File Search Store",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [250, 300]
    }
  ]
}`;
                    explainText = t('docs.explain.createStore');
                    break;

                case 'list-stores':
                    code = `{
  "nodes": [
    {
      "parameters": {
        "method": "GET",
        "url": "https://generativelanguage.googleapis.com/v1beta/fileSearchStores",
        "authentication": "genericCredentialType",
        "genericAuthType": "queryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "${params.apiKey}"
            },
            {
              "name": "pageSize",
              "value": "20"
            }
          ]
        },
        "options": {}
      },
      "name": "List File Search Stores",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [250, 300]
    }
  ]
}`;
                    explainText = t('docs.explain.listStores');
                    break;

                case 'upload-document':
                    code = `{
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/${params.uploadStore}:uploadToFileSearchStore",
        "authentication": "genericCredentialType",
        "genericAuthType": "queryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "${params.apiKey}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Goog-Upload-Protocol",
              "value": "resumable"
            },
            {
              "name": "X-Goog-Upload-Command",
              "value": "start"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "file.displayName",
              "value": "${params.fileName}"
            }
          ]
        },
        "options": {}
      },
      "name": "Upload to File Search Store",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [250, 300]
    }
  ]
}`;
                    explainText = t('docs.explain.uploadDocument');
                    break;

                case 'chat-rag':
                    code = `{
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/${params.model}:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "queryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "${params.apiKey}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\\n  \\"contents\\": [{\\n    \\"parts\\": [{ \\"text\\": \\"${params.query}\\" }]\\n  }],\\n  \\"tools\\": [{\\n    \\"fileSearchTool\\": {\\n      \\"fileSearchStores\\": [\\"${params.chatStore}\\"]\\n    }\\n  }]\\n}",
        "options": {}
      },
      "name": "RAG Query",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [250, 300]
    }
  ]
}`;
                    explainText = t('docs.explain.chatRag');
                    break;

                case 'list-documents':
                    code = `{
  "nodes": [
    {
      "parameters": {
        "method": "GET",
        "url": "https://generativelanguage.googleapis.com/v1beta/${params.listStore}/documents",
        "authentication": "genericCredentialType",
        "genericAuthType": "queryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "${params.apiKey}"
            },
            {
              "name": "pageSize",
              "value": "20"
            }
          ]
        },
        "options": {}
      },
      "name": "List Documents",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [250, 300]
    }
  ]
}`;
                    explainText = t('docs.explain.listDocuments');
                    break;

                case 'delete-document':
                    code = `{
  "nodes": [
    {
      "parameters": {
        "method": "DELETE",
        "url": "https://generativelanguage.googleapis.com/v1beta/${params.deleteDocStore}/documents/${params.docId}",
        "authentication": "genericCredentialType",
        "genericAuthType": "queryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "${params.apiKey}"
            },
            {
              "name": "force",
              "value": "true"
            }
          ]
        },
        "options": {}
      },
      "name": "Delete Document",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [250, 300]
    }
  ]
}`;
                    explainText = t('docs.explain.deleteDocument');
                    break;

                case 'delete-store':
                    code = `{
  "nodes": [
    {
      "parameters": {
        "method": "DELETE",
        "url": "https://generativelanguage.googleapis.com/v1beta/${params.deleteStore}",
        "authentication": "genericCredentialType",
        "genericAuthType": "queryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "${params.apiKey}"
            },
            {
              "name": "force",
              "value": "true"
            }
          ]
        },
        "options": {}
      },
      "name": "‚ö†Ô∏è Delete Store",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [250, 300]
    }
  ]
}`;
                    explainText = t('docs.explain.deleteStore');
                    break;

                case 'get-operation':
                    code = `{
  "nodes": [
    {
      "parameters": {
        "method": "GET",
        "url": "https://generativelanguage.googleapis.com/v1beta/${params.operationId}",
        "authentication": "genericCredentialType",
        "genericAuthType": "queryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "${params.apiKey}"
            }
          ]
        },
        "options": {}
      },
      "name": "Check Operation Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [250, 300]
    }
  ]
}`;
                    explainText = t('docs.explain.getOperation');
                    break;
            }

            return { code, explainText };
        }

        // Generate Make.com scenario
        function generateMake(operation, params) {
            let code = '';
            let explainText = '';

            switch(operation) {
                case 'create-store':
                    code = `{
  "name": "Create Gemini File Search Store",
  "flow": [
    {
      "id": 1,
      "module": "http:ActionSendData",
      "version": 3,
      "parameters": {
        "handleErrors": false,
        "useNewZLibDeCompress": true
      },
      "mapper": {
        "url": "https://generativelanguage.googleapis.com/v1beta/fileSearchStores?key=${params.apiKey}",
        "method": "post",
        "headers": [
          {
            "name": "Content-Type",
            "value": "application/json"
          }
        ],
        "qs": [],
        "bodyType": "raw",
        "rawBody": "{\\"displayName\\": \\"${params.storeName}\\"}"
      }
    }
  ]
}`;
                    explainText = t('docs.explain.createStore');
                    break;

                case 'list-stores':
                    code = `{
  "name": "List Gemini File Search Stores",
  "flow": [
    {
      "id": 1,
      "module": "http:ActionSendData",
      "version": 3,
      "parameters": {},
      "mapper": {
        "url": "https://generativelanguage.googleapis.com/v1beta/fileSearchStores?key=${params.apiKey}&pageSize=20",
        "method": "get",
        "headers": []
      }
    }
  ]
}`;
                    explainText = t('docs.explain.listStores');
                    break;

                case 'upload-document':
                    code = `{
  "name": "Upload to Gemini File Search Store",
  "flow": [
    {
      "id": 1,
      "module": "http:ActionSendData",
      "version": 3,
      "mapper": {
        "url": "https://generativelanguage.googleapis.com/v1beta/${params.uploadStore}:uploadToFileSearchStore?key=${params.apiKey}",
        "method": "post",
        "headers": [
          {
            "name": "X-Goog-Upload-Protocol",
            "value": "resumable"
          },
          {
            "name": "X-Goog-Upload-Command",
            "value": "start"
          },
          {
            "name": "Content-Type",
            "value": "application/json"
          }
        ],
        "bodyType": "raw",
        "rawBody": "{\\"file\\": {\\"displayName\\": \\"${params.fileName}\\"}}"
      }
    }
  ]
}`;
                    explainText = t('docs.explain.uploadDocument');
                    break;

                case 'chat-rag':
                    code = `{
  "name": "Gemini File Search Query",
  "flow": [
    {
      "id": 1,
      "module": "http:ActionSendData",
      "version": 3,
      "mapper": {
        "url": "https://generativelanguage.googleapis.com/v1beta/models/${params.model}:generateContent?key=${params.apiKey}",
        "method": "post",
        "headers": [
          {
            "name": "Content-Type",
            "value": "application/json"
          }
        ],
        "bodyType": "raw",
        "rawBody": "{\\"contents\\": [{\\"parts\\": [{\\"text\\": \\"${params.query}\\"}]}], \\"tools\\": [{\\"fileSearchTool\\": {\\"fileSearchStores\\": [\\"${params.chatStore}\\"]}}]}"
      }
    }
  ]
}`;
                    explainText = t('docs.explain.chatRag');
                    break;

                case 'list-documents':
                    code = `{
  "name": "List Documents in Store",
  "flow": [
    {
      "id": 1,
      "module": "http:ActionSendData",
      "version": 3,
      "mapper": {
        "url": "https://generativelanguage.googleapis.com/v1beta/${params.listStore}/documents?key=${params.apiKey}&pageSize=20",
        "method": "get"
      }
    }
  ]
}`;
                    explainText = t('docs.explain.listDocuments');
                    break;

                case 'delete-document':
                    code = `{
  "name": "Delete Document from Store",
  "flow": [
    {
      "id": 1,
      "module": "http:ActionSendData",
      "version": 3,
      "mapper": {
        "url": "https://generativelanguage.googleapis.com/v1beta/${params.deleteDocStore}/documents/${params.docId}?key=${params.apiKey}&force=true",
        "method": "delete"
      }
    }
  ]
}`;
                    explainText = t('docs.explain.deleteDocument');
                    break;

                case 'delete-store':
                    code = `{
  "name": "‚ö†Ô∏è Delete File Search Store",
  "flow": [
    {
      "id": 1,
      "module": "http:ActionSendData",
      "version": 3,
      "mapper": {
        "url": "https://generativelanguage.googleapis.com/v1beta/${params.deleteStore}?key=${params.apiKey}&force=true",
        "method": "delete"
      }
    }
  ]
}`;
                    explainText = t('docs.explain.deleteStore');
                    break;

                case 'get-operation':
                    code = `{
  "name": "Check Operation Status",
  "flow": [
    {
      "id": 1,
      "module": "http:ActionSendData",
      "version": 3,
      "mapper": {
        "url": "https://generativelanguage.googleapis.com/v1beta/${params.operationId}?key=${params.apiKey}",
        "method": "get"
      }
    }
  ]
}`;
                    explainText = t('docs.explain.getOperation');
                    break;
            }

            return { code, explainText };
        }

        // Generate Postman collection
        function generatePostman(operation, params) {
            let code = '';
            let explainText = '';

            switch(operation) {
                case 'create-store':
                    code = `{
  "info": {
    "name": "Gemini File Search - Create Store",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Create File Search Store",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "https://generativelanguage.googleapis.com/v1beta/fileSearchStores?key=${params.apiKey}",
          "protocol": "https",
          "host": ["generativelanguage", "googleapis", "com"],
          "path": ["v1beta", "fileSearchStores"],
          "query": [
            {
              "key": "key",
              "value": "${params.apiKey}"
            }
          ]
        },
        "body": {
          "mode": "raw",
          "raw": "{\\n  \\"displayName\\": \\"${params.storeName}\\"\\n}"
        }
      }
    }
  ]
}`;
                    explainText = t('docs.explain.createStore');
                    break;

                case 'list-stores':
                    code = `{
  "info": {
    "name": "Gemini File Search - List Stores",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "List File Search Stores",
      "request": {
        "method": "GET",
        "url": {
          "raw": "https://generativelanguage.googleapis.com/v1beta/fileSearchStores?key=${params.apiKey}&pageSize=20",
          "protocol": "https",
          "host": ["generativelanguage", "googleapis", "com"],
          "path": ["v1beta", "fileSearchStores"],
          "query": [
            {
              "key": "key",
              "value": "${params.apiKey}"
            },
            {
              "key": "pageSize",
              "value": "20"
            }
          ]
        }
      }
    }
  ]
}`;
                    explainText = t('docs.explain.listStores');
                    break;

                case 'upload-document':
                    code = `{
  "info": {
    "name": "Gemini File Search - Upload Document",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Step 1: Get Upload URL",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "X-Goog-Upload-Protocol",
            "value": "resumable"
          },
          {
            "key": "X-Goog-Upload-Command",
            "value": "start"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "https://generativelanguage.googleapis.com/v1beta/${params.uploadStore}:uploadToFileSearchStore?key=${params.apiKey}",
          "protocol": "https",
          "host": ["generativelanguage", "googleapis", "com"],
          "path": ["v1beta", "${params.uploadStore}:uploadToFileSearchStore"]
        },
        "body": {
          "mode": "raw",
          "raw": "{\\n  \\"file\\": {\\n    \\"displayName\\": \\"${params.fileName}\\"\\n  }\\n}"
        }
      }
    }
  ]
}`;
                    explainText = t('docs.explain.uploadDocument');
                    break;

                case 'chat-rag':
                    code = `{
  "info": {
    "name": "Gemini File Search - RAG Query",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "RAG Query",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "https://generativelanguage.googleapis.com/v1beta/models/${params.model}:generateContent?key=${params.apiKey}",
          "protocol": "https",
          "host": ["generativelanguage", "googleapis", "com"],
          "path": ["v1beta", "models", "${params.model}:generateContent"]
        },
        "body": {
          "mode": "raw",
          "raw": "{\\n  \\"contents\\": [{\\n    \\"parts\\": [{\\"text\\": \\"${params.query}\\"}]\\n  }],\\n  \\"tools\\": [{\\n    \\"fileSearchTool\\": {\\n      \\"fileSearchStores\\": [\\"${params.chatStore}\\"]\\n    }\\n  }]\\n}"
        }
      }
    }
  ]
}`;
                    explainText = t('docs.explain.chatRag');
                    break;

                case 'list-documents':
                    code = `{
  "info": {
    "name": "Gemini File Search - List Documents",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "List Documents",
      "request": {
        "method": "GET",
        "url": {
          "raw": "https://generativelanguage.googleapis.com/v1beta/${params.listStore}/documents?key=${params.apiKey}&pageSize=20",
          "protocol": "https",
          "host": ["generativelanguage", "googleapis", "com"],
          "path": ["v1beta", "${params.listStore}", "documents"]
        }
      }
    }
  ]
}`;
                    explainText = t('docs.explain.listDocuments');
                    break;

                case 'delete-document':
                    code = `{
  "info": {
    "name": "Gemini File Search - Delete Document",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Delete Document",
      "request": {
        "method": "DELETE",
        "url": {
          "raw": "https://generativelanguage.googleapis.com/v1beta/${params.deleteDocStore}/documents/${params.docId}?key=${params.apiKey}&force=true",
          "protocol": "https",
          "host": ["generativelanguage", "googleapis", "com"],
          "path": ["v1beta", "${params.deleteDocStore}", "documents", "${params.docId}"]
        }
      }
    }
  ]
}`;
                    explainText = t('docs.explain.deleteDocument');
                    break;

                case 'delete-store':
                    code = `{
  "info": {
    "name": "Gemini File Search - ‚ö†Ô∏è Delete Store",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "‚ö†Ô∏è Delete Store",
      "request": {
        "method": "DELETE",
        "url": {
          "raw": "https://generativelanguage.googleapis.com/v1beta/${params.deleteStore}?key=${params.apiKey}&force=true",
          "protocol": "https",
          "host": ["generativelanguage", "googleapis", "com"],
          "path": ["v1beta", "${params.deleteStore}"]
        }
      }
    }
  ]
}`;
                    explainText = t('docs.explain.deleteStore');
                    break;

                case 'get-operation':
                    code = `{
  "info": {
    "name": "Gemini File Search - Check Operation",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Check Operation Status",
      "request": {
        "method": "GET",
        "url": {
          "raw": "https://generativelanguage.googleapis.com/v1beta/${params.operationId}?key=${params.apiKey}",
          "protocol": "https",
          "host": ["generativelanguage", "googleapis", "com"],
          "path": ["v1beta", "${params.operationId}"]
        }
      }
    }
  ]
}`;
                    explainText = t('docs.explain.getOperation');
                    break;
            }

            return { code, explainText };
        }

        // Update API key
        window.updateApiKey = async function() {
            const input = document.getElementById('newApiKeyInput');
            const newApiKey = input.value.trim();

            if (!newApiKey || !confirm('Update API key?')) return;

            try {
                const response = await fetch('/update-api-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: newApiKey })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úÖ ' + data.message);
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Failed to update: ' + error.message);
            }
        };

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Load initial state
        async function loadInitialState() {
            try {
                const response = await fetch('/status');
                const data = await response.json();

                if (data.file_uploaded) {
                    fileUploaded = true;
                    chatInput.disabled = false;
                    sendBtn.disabled = false;
                }

                // Load current store info and update header
                const storeResponse = await fetch('/current-store-documents');
                const storeData = await storeResponse.json();

                if (storeData.success && storeData.store_name) {
                    updateCurrentStoreHeader(storeData.store_display_name || storeData.store_name);
                }

            } catch (error) {
                console.error('Error loading state:', error);
            }
        }

        // Load Documents Tab
        async function loadDocumentsTab() {
            const container = document.getElementById('documentsTabList');

            try {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6B7280;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 12px;">Cargando documentos...</p>
                    </div>
                `;

                const response = await fetch('/current-store-documents');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al cargar documentos');
                }

                if (!data.documents || data.documents.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px; color: #6B7280;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                            <h3 style="color: #374151; margin-bottom: 8px;">No hay documentos</h3>
                            <p>Ve a la pesta√±a Chat y sube un documento para empezar</p>
                        </div>
                    `;
                    return;
                }

                // Update header with current store
                updateCurrentStoreHeader(data.store_display_name || data.store_name);

                // Display documents
                const documentsHTML = data.documents.map(doc => {
                    const docCreatedDate = new Date(doc.createTime || doc.create_time).toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const sizeKB = Math.round((doc.sizeBytes || doc.size_bytes || 0) / 1024);
                    const stateEmoji = doc.state === 'STATE_ACTIVE' ? '‚úÖ' : doc.state === 'STATE_PENDING' ? '‚è≥' : '‚ùå';
                    const stateText = doc.state === 'STATE_ACTIVE' ? 'Activo' : doc.state === 'STATE_PENDING' ? 'Pendiente' : 'Fallido';
                    const stateColor = doc.state === 'STATE_ACTIVE' ? '#059669' : doc.state === 'STATE_PENDING' ? '#D97706' : '#DC2626';

                    const metadata = doc.customMetadata || doc.custom_metadata || {};
                    const metadataKeys = Object.keys(metadata);
                    const metadataHTML = metadataKeys.length > 0 ? `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #E5E7EB;">
                            <div style="font-size: 12px; font-weight: 600; color: #6B7280; margin-bottom: 8px;">Metadatos:</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${metadataKeys.map(key => `
                                    <span style="background: #DBEAFE; color: #1E40AF; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                        ${key}: ${metadata[key]}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : '';

                    return `
                        <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 16px; color: #111827; margin-bottom: 8px;">
                                        üìÑ ${doc.displayName || doc.display_name || 'Sin nombre'}
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px; color: #6B7280;">
                                        <span>üìä ${sizeKB} KB</span>
                                        <span style="color: ${stateColor};">${stateEmoji} ${stateText}</span>
                                        <span>üìÖ ${docCreatedDate}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn-secondary edit-doc-btn-tab" style="padding: 8px 12px; font-size: 13px;"
                                            data-doc-name="${doc.name}"
                                            data-metadata='${JSON.stringify(metadata)}'>
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button class="btn-danger delete-doc-btn-tab" style="padding: 8px 12px; font-size: 13px;"
                                            data-doc-name="${doc.name}">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            </div>
                            ${metadataHTML}
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div style="margin-bottom: 20px; padding: 16px; background: #EFF6FF; border-radius: 12px; border: 1px solid #BFDBFE;">
                        <div style="font-size: 14px; color: #1E40AF;">
                            <strong>Store:</strong> ${data.store_display_name || data.store_name}
                        </div>
                        <div style="font-size: 14px; color: #1E40AF; margin-top: 4px;">
                            <strong>Total documentos:</strong> ${data.documents.length}
                        </div>
                    </div>
                    ${documentsHTML}
                `;

                // Add event listeners
                document.querySelectorAll('.edit-doc-btn-tab').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const docName = e.target.dataset.docName;
                        const currentMetadata = JSON.parse(e.target.dataset.metadata || '{}');
                        await editDocumentMetadata(docName, currentMetadata);
                    });
                });

                document.querySelectorAll('.delete-doc-btn-tab').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const docName = e.target.dataset.docName;
                        await deleteDocumentFromTab(docName);
                    });
                });

            } catch (error) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #EF4444;">
                        <h3>‚ùå Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Load Stores Tab
        async function loadStoresTab() {
            const container = document.getElementById('storesTabList');

            try {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6B7280;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 12px;">Cargando stores...</p>
                    </div>
                `;

                const response = await fetch('/stores');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al cargar stores');
                }

                if (!data.stores || data.stores.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px; color: #6B7280;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üì¶</div>
                            <h3 style="color: #374151; margin-bottom: 8px;">No hay stores</h3>
                            <p>Sube un documento en la pesta√±a Chat para crear tu primer store</p>
                        </div>
                    `;
                    return;
                }

                // Display stores (reutilizando el c√≥digo del modal de stores)
                const storesHTML = data.stores.map((store, index) => {
                    const storeDocs = store.documents || [];
                    const storeId = `store-docs-${index}`;
                    return `
                        <div style="background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 8px 0; color: #111827;">üì¶ ${store.display_name || store.name}</h3>
                                    <div style="font-size: 13px; color: #6B7280;">
                                        <span>üìä ${store.active_documents_count || 0} ${t('stores.activeDocuments')}</span>
                                        <span style="margin-left: 16px;">üíæ ${Math.round(store.size_bytes / 1024)} KB</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    ${storeDocs.length > 0 ? `
                                        <button
                                            onclick="toggleStoreDocuments('${storeId}')"
                                            id="toggle-btn-${storeId}"
                                            style="padding: 8px 16px; background: #0081BA; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s;"
                                            onmouseover="this.style.background='#005a8a'"
                                            onmouseout="this.style.background='#0081BA'">
                                            ${t('stores.viewDocuments')} (${storeDocs.length})
                                        </button>
                                    ` : ''}
                                    <button
                                        onclick="deleteStore('${store.name}', '${store.display_name || store.name}')"
                                        style="padding: 8px 16px; background: #EF4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s;"
                                        onmouseover="this.style.background='#DC2626'"
                                        onmouseout="this.style.background='#EF4444'">
                                        ${t('stores.deleteStore')}
                                    </button>
                                </div>
                            </div>
                            ${storeDocs.length > 0 ? `
                                <div id="${storeId}" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #E5E7EB;">
                                    <div style="font-weight: 600; font-size: 14px; color: #374151; margin-bottom: 12px;">üìÑ Documentos en este store:</div>
                                    ${storeDocs.map(doc => {
                                        const metadata = doc.custom_metadata || {};
                                        const metadataKeys = Object.keys(metadata);
                                        return `
                                            <div style="background: #F9FAFB; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #E5E7EB;">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                    <div style="flex: 1;">
                                                        <div style="font-size: 14px; font-weight: 500; color: #111827; margin-bottom: 4px;">
                                                            üìÑ ${doc.display_name || 'Sin nombre'}
                                                        </div>
                                                        <div style="font-size: 11px; color: #9CA3AF;">
                                                            ${doc.name}
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 6px;">
                                                        <button
                                                            class="edit-doc-btn-store"
                                                            data-doc-name="${doc.name}"
                                                            data-doc-display="${doc.display_name || 'Sin nombre'}"
                                                            data-metadata='${JSON.stringify(metadata)}'
                                                            style="padding: 6px 12px; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: background 0.2s;"
                                                            onmouseover="this.style.background='#2563EB'"
                                                            onmouseout="this.style.background='#3B82F6'">
                                                            ${t('stores.editMetadata')}
                                                        </button>
                                                        <button
                                                            class="delete-doc-btn-store"
                                                            data-doc-name="${doc.name}"
                                                            data-doc-display="${doc.display_name || 'Sin nombre'}"
                                                            style="padding: 6px 12px; background: #EF4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: background 0.2s;"
                                                            onmouseover="this.style.background='#DC2626'"
                                                            onmouseout="this.style.background='#EF4444'">
                                                            ${t('stores.deleteDocument')}
                                                        </button>
                                                    </div>
                                                </div>
                                                ${metadataKeys.length > 0 ? `
                                                    <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #E5E7EB;">
                                                        ${metadataKeys.map(key => `
                                                            <span style="background: #DBEAFE; color: #1E40AF; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                                                <strong>${key}:</strong> ${metadata[key]}
                                                            </span>
                                                        `).join('')}
                                                    </div>
                                                ` : `<div style="text-align: center; color: #9CA3AF; font-size: 12px; padding: 8px; background: white; border-radius: 4px; margin-top: 8px;">${t('stores.noMetadata')}</div>`}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `<p style="text-align: center; color: #9CA3AF; padding: 20px; margin: 0;">${t('stores.noDocumentsInStore')}</p>`}
                        </div>
                    `;
                }).join('');

                container.innerHTML = storesHTML;

                // Attach event listeners for edit and delete buttons in stores tab
                document.querySelectorAll('.edit-doc-btn-store').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const docName = e.target.dataset.docName;
                        const currentMetadata = JSON.parse(e.target.dataset.metadata || '{}');
                        await editDocumentMetadata(docName, currentMetadata);
                    });
                });

                document.querySelectorAll('.delete-doc-btn-store').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const docName = e.target.dataset.docName;
                        await deleteDocumentFromStore(docName);
                    });
                });

            } catch (error) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #EF4444;">
                        <h3>‚ùå Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Update current store header
        function updateCurrentStoreHeader(storeName) {
            const headerElement = document.getElementById('currentStoreName');
            if (headerElement) {
                headerElement.textContent = storeName || 'No seleccionado';
            }
        }

        // Toggle store documents visibility (collapse/expand)
        function toggleStoreDocuments(storeId) {
            const docsContainer = document.getElementById(storeId);
            const toggleBtn = document.getElementById(`toggle-btn-${storeId}`);

            if (docsContainer.style.display === 'none') {
                // Expand
                docsContainer.style.display = 'block';
                const docCount = toggleBtn.innerHTML.match(/\((\d+)\)/)?.[1] || '0';
                toggleBtn.innerHTML = `${t('stores.hideDocuments')} (${docCount})`;
            } else {
                // Collapse
                docsContainer.style.display = 'none';
                const docCount = toggleBtn.innerHTML.match(/\((\d+)\)/)?.[1] || '0';
                toggleBtn.innerHTML = `${t('stores.viewDocuments')} (${docCount})`;
            }
        }

        // Delete File Search Store
        async function deleteStore(storeName, displayName) {
            const docsCount = document.querySelector(`button[onclick*="${storeName}"]`)
                ?.closest('div[style*="background: white"]')
                ?.querySelector('span')?.textContent.match(/\d+/)?.[0] || '?';

            if (!confirm(`‚ö†Ô∏è ADVERTENCIA: Vas a eliminar el File Search Store completo\n\nStore: ${displayName}\nDocumentos: ${docsCount}\n\nEsto eliminar√°:\n‚úì El store\n‚úì TODOS los documentos (${docsCount})\n‚úì Todos los metadatos\n‚úì Todos los embeddings\n\nEsta acci√≥n NO se puede deshacer.\n\n¬øEst√°s TOTALMENTE seguro?`)) {
                return;
            }

            try {
                const response = await fetch('/delete-store', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ store_name: storeName })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al eliminar store');
                }

                showNotification('‚úÖ File Search Store eliminado correctamente', 'success');

                // Reload stores tab
                await loadStoresTab();

                // Update header if this was the current store
                updateCurrentStoreHeader('No seleccionado');

            } catch (error) {
                showNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Delete document from stores tab
        async function deleteDocumentFromStore(documentName) {
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar este documento?\n\n${documentName.split('/').pop()}\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }

            try {
                const response = await fetch('/delete-document', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ document_name: documentName })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al eliminar documento');
                }

                showNotification('‚úÖ Documento eliminado correctamente', 'success');

                // Reload stores tab
                await loadStoresTab();

            } catch (error) {
                showNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Delete document from tab
        async function deleteDocumentFromTab(documentName) {
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar este documento?\n\n${documentName.split('/').pop()}\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }

            try {
                const response = await fetch('/delete-document', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ document_name: documentName })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al eliminar documento');
                }

                showNotification('‚úÖ Documento eliminado correctamente', 'success');

                // Reload stores tab
                await loadStoresTab();

            } catch (error) {
                showNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Delete document from main view
        async function deleteDocumentMain(documentName) {
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar este documento?\n\n${documentName.split('/').pop()}\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }

            try {
                const response = await fetch('/delete-document', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ document_name: documentName })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al eliminar documento');
                }

                showNotification('‚úÖ Documento eliminado correctamente', 'success');

                // Reload current store documents
                await loadCurrentStoreDocuments();

            } catch (error) {
                showNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        loadInitialState();
    </script>

    <script>
        // Store Management removed - now in tabs
        async function loadAllStores_DEPRECATED() {
            try {
                storesListContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6B7280;">
                        <div class="loading-spinner"></div>
                        <p>Cargando stores...</p>
                    </div>
                `;

                const response = await fetch('/stores');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al cargar stores');
                }

                displayStores(data.stores, data.current_store);
            } catch (error) {
                storesListContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #EF4444;">
                        <p>‚ùå Error: ${error.message}</p>
                        <button class="btn btn-primary" onclick="loadAllStores()" style="margin-top: 16px;">
                            üîÑ Reintentar
                        </button>
                    </div>
                `;
            }
        }

        // Display stores in modal
        function displayStores(stores, currentStore) {
            if (!stores || stores.length === 0) {
                storesListContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6B7280;">
                        <p>üì≠ No tienes stores creados todav√≠a</p>
                        <p style="font-size: 14px; margin-top: 8px;">Crea uno usando el bot√≥n "Crear Store" arriba</p>
                    </div>
                `;
                return;
            }

            const storesHTML = stores.map((store, storeIndex) => {
                const isActive = store.name === currentStore;
                const createdDate = new Date(store.createTime || store.create_time).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const documents = store.documents || [];
                const documentsHTML = documents.length > 0 ? documents.map(doc => {
                    const docCreatedDate = new Date(doc.createTime || doc.create_time).toLocaleDateString('es-ES');
                    const sizeKB = Math.round((doc.sizeBytes || doc.size_bytes || 0) / 1024);
                    const stateEmoji = doc.state === 'STATE_ACTIVE' ? '‚úÖ' : doc.state === 'STATE_PENDING' ? '‚è≥' : '‚ùå';
                    const stateText = doc.state === 'STATE_ACTIVE' ? 'Activo' : doc.state === 'STATE_PENDING' ? 'Pendiente' : 'Fallido';

                    // Build metadata HTML
                    const metadata = doc.customMetadata || doc.custom_metadata || {};
                    const metadataKeys = Object.keys(metadata);
                    const metadataHTML = metadataKeys.length > 0 ? `
                        <div style="margin-top: 8px; padding: 8px; background: #F9FAFB; border-radius: 6px; border: 1px solid #E5E7EB;">
                            <div style="font-size: 11px; font-weight: 600; color: #374151; margin-bottom: 4px;">üè∑Ô∏è Metadatos:</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${metadataKeys.map(key => `
                                    <span style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: #EFF6FF; border: 1px solid #BFDBFE; border-radius: 4px; font-size: 11px; color: #1E40AF;">
                                        <strong>${key}:</strong> ${metadata[key]}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : '';

                    return `
                        <div class="document-item" style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #E5E7EB;">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 500; color: #111827; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                                        ${stateEmoji} ${doc.displayName || doc.display_name || 'Sin nombre'}
                                    </div>
                                    <div style="font-size: 11px; color: #6B7280; font-family: monospace; word-break: break-all; margin-bottom: 6px;">
                                        ${doc.name}
                                    </div>
                                    <div style="display: flex; gap: 12px; font-size: 12px; color: #6B7280; flex-wrap: wrap;">
                                        <span>üìä ${sizeKB} KB</span>
                                        <span>üìÖ ${docCreatedDate}</span>
                                        <span style="color: ${doc.state === 'STATE_ACTIVE' ? '#059669' : doc.state === 'STATE_PENDING' ? '#D97706' : '#DC2626'};">${stateText}</span>
                                        ${metadataKeys.length > 0 ? `<span style="color: #0081BA;">üè∑Ô∏è ${metadataKeys.length} metadatos</span>` : ''}
                                    </div>
                                    ${metadataHTML}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 6px;">
                                    <button class="edit-doc-btn" data-doc-name="${doc.name}" data-store-index="${storeIndex}" data-metadata='${JSON.stringify(metadata)}'
                                        style="padding: 6px 12px; background: #DBEAFE; color: #1E40AF; border: 1px solid #93C5FD; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap; transition: all 0.2s;">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button class="delete-doc-btn" data-doc-name="${doc.name}" data-store-index="${storeIndex}"
                                        style="padding: 6px 12px; background: #FEE2E2; color: #DC2626; border: 1px solid #FCA5A5; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap; transition: all 0.2s;">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') : `
                    <div style="text-align: center; padding: 20px; color: #9CA3AF; font-size: 13px;">
                        üì≠ No hay documentos en este store
                    </div>
                `;

                return `
                    <div class="store-card ${isActive ? 'active' : ''}" data-store-name="${store.name}">
                        <div class="store-header">
                            <div>
                                <h3 style="margin: 0 0 8px 0; color: #111827; display: flex; align-items: center; gap: 8px;">
                                    ${isActive ? '‚úÖ' : 'üì¶'} ${store.displayName || store.display_name || 'Sin nombre'}
                                    ${isActive ? '<span class="store-badge">ACTIVO</span>' : ''}
                                </h3>
                                <p style="margin: 0; font-size: 13px; color: #6B7280; font-family: monospace;">
                                    ${store.name}
                                </p>
                            </div>
                        </div>
                        <div class="store-stats">
                            <div class="stat-item">
                                <span class="stat-icon">üìÑ</span>
                                <div>
                                    <div class="stat-label">Documentos Activos</div>
                                    <div class="stat-value">${store.activeDocumentsCount || store.active_documents_count || 0}</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">‚è≥</span>
                                <div>
                                    <div class="stat-label">Pendientes</div>
                                    <div class="stat-value">${store.pendingDocumentsCount || store.pending_documents_count || 0}</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">üìÖ</span>
                                <div>
                                    <div class="stat-label">Creado</div>
                                    <div class="stat-value" style="font-size: 12px;">${createdDate}</div>
                                </div>
                            </div>
                        </div>

                        ${documents.length > 0 ? `
                            <button class="toggle-docs-btn" data-store-index="${storeIndex}"
                                style="width: 100%; margin-top: 12px; padding: 8px; background: #F3F4F6; border: 1px solid #D1D5DB; border-radius: 8px; cursor: pointer; font-weight: 500; color: #374151; transition: all 0.2s;">
                                üìÇ Ver Documentos (${documents.length})
                            </button>
                            <div class="documents-list" id="docs-${storeIndex}" style="display: none; margin-top: 12px; padding: 12px; background: #F9FAFB; border-radius: 8px;">
                                ${documentsHTML}
                            </div>
                        ` : ''}

                        ${!isActive ? `
                            <button class="btn btn-primary switch-store-btn" data-store-name="${store.name}" style="width: 100%; margin-top: 12px;">
                                üîÑ Cambiar a este store
                            </button>
                        ` : `
                            <div style="text-align: center; padding: 8px; margin-top: 12px; background: #D1FAE5; border-radius: 8px; color: #065F46; font-weight: 500;">
                                Este es tu store actual
                            </div>
                        `}
                    </div>
                `;
            }).join('');

            storesListContainer.innerHTML = `
                <div style="margin-bottom: 16px; padding: 12px; background: #EFF6FF; border-radius: 8px; border-left: 4px solid #3B82F6;">
                    <p style="margin: 0; color: #1E40AF; font-size: 14px;">
                        üí° <strong>Total de stores:</strong> ${stores.length}
                    </p>
                </div>
                ${storesHTML}
            `;

            // Add click handlers to switch buttons
            document.querySelectorAll('.switch-store-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const storeName = e.target.dataset.storeName;
                    await switchToStore(storeName);
                });
            });

            // Add click handlers to toggle documents buttons
            document.querySelectorAll('.toggle-docs-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const storeIndex = e.target.dataset.storeIndex;
                    const docsList = document.getElementById(`docs-${storeIndex}`);
                    const isVisible = docsList.style.display !== 'none';

                    docsList.style.display = isVisible ? 'none' : 'block';
                    e.target.innerHTML = isVisible ?
                        `üìÇ Ver Documentos (${stores[storeIndex].documents.length})` :
                        `üìÅ Ocultar Documentos`;
                });
            });

            // Add click handlers to delete document buttons
            document.querySelectorAll('.delete-doc-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const docName = e.target.dataset.docName;
                    const storeIndex = e.target.dataset.storeIndex;
                    await deleteDocument(docName, storeIndex, stores);
                });
            });

            // Add click handlers to edit document buttons
            document.querySelectorAll('.edit-doc-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const docName = e.target.dataset.docName;
                    const currentMetadata = JSON.parse(e.target.dataset.metadata || '{}');
                    await editDocumentMetadata(docName, currentMetadata);
                });
            });
        }

        // Switch to a different store
        async function switchToStore(storeName) {
            try {
                const response = await fetch('/switch-store', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ store_name: storeName })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al cambiar de store');
                }

                // Show success message
                showNotification('‚úÖ Store cambiado correctamente', 'success');

                // Close modal
                storesModal.style.display = 'none';

                // Reload page state
                await loadInitialState();

            } catch (error) {
                showNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Delete a document from a store
        async function deleteDocument(documentName, storeIndex, stores) {
            // Confirm deletion
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar este documento?\n\n${documentName.split('/').pop()}\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }

            try {
                const response = await fetch('/delete-document', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ document_name: documentName })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al eliminar documento');
                }

                // Show success message
                showNotification('‚úÖ Documento eliminado correctamente', 'success');

                // Reload the stores list to reflect changes
                await loadAllStores();

                // If the deleted document was from the current store, reload page state
                if (file_search_store && documentName.startsWith(file_search_store.name)) {
                    await loadInitialState();
                }

            } catch (error) {
                showNotification(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Edit document metadata
        async function editDocumentMetadata(documentName, currentMetadata) {
            // Create modal HTML
            const modalHTML = `
                <div class="modal-overlay" id="editMetadataModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h2 style="margin: 0; color: #111827;">‚úèÔ∏è Editar Metadatos</h2>
                            <button class="modal-close" id="closeEditModal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p style="margin: 0 0 16px 0; font-size: 14px; color: #6B7280;">
                                Documento: <strong>${documentName.split('/').pop()}</strong>
                            </p>

                            <!-- Info Banner about AI Suggestion -->
                            <div style="margin-bottom: 16px; padding: 12px; background: #FEF3C7; border-left: 4px solid #F59E0B; border-radius: 8px;">
                                <div style="display: flex; gap: 8px; align-items: start;">
                                    <span style="font-size: 18px;">üí°</span>
                                    <div style="flex: 1;">
                                        <strong style="display: block; color: #92400E; font-size: 13px; margin-bottom: 4px;">
                                            Sobre la sugerencia de metadatos con IA
                                        </strong>
                                        <p style="margin: 0; color: #78350F; font-size: 12px; line-height: 1.5;">
                                            La generaci√≥n autom√°tica de metadatos con IA solo est√° disponible <strong>antes de subir</strong> el documento.
                                            Una vez procesado en el File Search store, solo puedes editar los metadatos manualmente o usar plantillas.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Templates Selector for Edit Modal -->
                            <div style="margin-bottom: 16px; padding: 12px; background: #EFF6FF; border-radius: 8px; border: 1px solid #BFDBFE;">
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #1E40AF;">
                                    üìã Usar plantilla predefinida:
                                </label>
                                <select id="editMetadataTemplate" style="width: 100%; padding: 8px; border: 1px solid #93C5FD; border-radius: 6px; font-size: 14px; background: white;">
                                    <option value="">-- Selecciona un tipo de documento --</option>
                                    <option value="factura">üìÑ Factura</option>
                                    <option value="contrato">üìù Contrato</option>
                                    <option value="informe">üìä Informe</option>
                                    <option value="manual">üìñ Manual/Gu√≠a</option>
                                    <option value="presentacion">üìΩÔ∏è Presentaci√≥n</option>
                                    <option value="acta">üìã Acta/Minuta</option>
                                    <option value="certificado">üéì Certificado</option>
                                    <option value="email">‚úâÔ∏è Email/Comunicaci√≥n</option>
                                </select>
                            </div>

                            <div id="editMetadataFields"></div>
                            <button id="addEditMetadataField" class="btn-secondary" style="width: 100%; margin-top: 12px;">
                                ‚ûï Agregar campo
                            </button>
                            <div style="display: flex; gap: 8px; margin-top: 16px;">
                                <button id="saveEditMetadata" class="btn btn-primary" style="flex: 1;">
                                    üíæ Guardar Cambios
                                </button>
                                <button id="cancelEditMetadata" class="btn-secondary" style="flex: 1;">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            const modal = document.getElementById('editMetadataModal');
            const fieldsContainer = document.getElementById('editMetadataFields');
            let editFieldCount = 0;

            // Function to add metadata field
            function addEditField(key = '', value = '', type = 'string') {
                const fieldId = `edit-metadata-${editFieldCount++}`;
                const fieldHTML = `
                    <div class="metadata-field" id="${fieldId}" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: start;">
                        <input type="text" value="${key}" placeholder="Clave" class="metadata-key"
                            style="flex: 1; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                        <input type="text" value="${value}" placeholder="Valor" class="metadata-value"
                            style="flex: 1; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                        <select class="metadata-type" style="padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 14px;">
                            <option value="string" ${type === 'string' ? 'selected' : ''}>Texto</option>
                            <option value="number" ${type === 'number' ? 'selected' : ''}>N√∫mero</option>
                        </select>
                        <button onclick="document.getElementById('${fieldId}').remove()" class="btn-secondary" style="padding: 8px 12px; font-size: 12px;">
                            ‚ùå
                        </button>
                    </div>
                `;
                fieldsContainer.insertAdjacentHTML('beforeend', fieldHTML);
            }

            // Pre-populate with existing metadata
            Object.entries(currentMetadata).forEach(([key, value]) => {
                const type = typeof value === 'number' ? 'number' : 'string';
                addEditField(key, value, type);
            });

            // If no metadata, add one empty field
            if (Object.keys(currentMetadata).length === 0) {
                addEditField();
            }

            // Event listeners
            document.getElementById('addEditMetadataField').addEventListener('click', () => addEditField());

            // Template selector for edit modal
            document.getElementById('editMetadataTemplate').addEventListener('change', (e) => {
                const templateName = e.target.value;
                if (!templateName) return;

                // Clear existing fields
                fieldsContainer.innerHTML = '';
                editFieldCount = 0;

                // Apply template
                const template = metadataTemplates[templateName];
                if (template) {
                    template.forEach(field => {
                        addEditField(field.key, field.value, field.type);
                    });
                    showNotification(`‚úÖ Plantilla "${e.target.options[e.target.selectedIndex].text}" aplicada`, 'success');
                }
            });

            document.getElementById('closeEditModal').addEventListener('click', () => modal.remove());
            document.getElementById('cancelEditMetadata').addEventListener('click', () => modal.remove());

            document.getElementById('saveEditMetadata').addEventListener('click', async () => {
                // Collect metadata
                const newMetadata = {};
                const fields = fieldsContainer.querySelectorAll('.metadata-field');
                fields.forEach(field => {
                    const key = field.querySelector('.metadata-key').value.trim();
                    const value = field.querySelector('.metadata-value').value.trim();
                    const type = field.querySelector('.metadata-type').value;

                    if (key && value) {
                        newMetadata[key] = type === 'number' ? parseFloat(value) : value;
                    }
                });

                // Save metadata
                try {
                    const response = await fetch('/update-document-metadata', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            document_name: documentName,
                            metadata: newMetadata
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Error al actualizar metadatos');
                    }

                    showNotification(`‚úÖ ${t('upload.metadata.updatedNotification')}`, 'success');
                    modal.remove();

                    // Reload stores list
                    await loadAllStores();

                } catch (error) {
                    showNotification(`‚ùå Error: ${error.message}`, 'error');
                }
            });

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#3B82F6'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                font-weight: 500;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Initialize language on page load
        changeLanguage(currentLang);
    </script>
</body>
</html>
